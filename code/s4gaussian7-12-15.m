function S4=s4gaussian(N,NM,LAM,FA,Q1,Q2,Q3,Q4,d)
%S4 is a four point correlation function
%For example:
%   S4(1,1,1,1)=SAAAA
%   S4(1,1,2,1)=SAABA

S4=zeros(2,2,2,2);
MIN=1e-6;
% MIN=1e-10;
digits(5);

% Reset Qs to column vectors if entered as rows
if isrow(Q1)==1
    Q1=transpose(Q1);
    Q2=transpose(Q2);
    Q3=transpose(Q3);
    Q4=transpose(Q4);
end

% Begin calculation of s4
if sum(power(Q1+Q2+Q3+Q4,2)) <= MIN

    % Evaluate the quantities for s4 calculation
    FB=1-FA;
    F=[FA,FB];
    DF=[1,-1];

    Q1MAG=sqrt(sum(power(Q1,2)));
    Q2MAG=sqrt(sum(power(Q2,2)));
    Q3MAG=sqrt(sum(power(Q3,2)));
    Q4MAG=sqrt(sum(power(Q4,2)));
    
    R1=-Q1MAG*Q1MAG/(2*d);
    R2=-Q2MAG*Q2MAG/(2*d);
    R3=-Q3MAG*Q3MAG/(2*d);
    R4=-Q4MAG*Q4MAG/(2*d);
    
    Q12MAG=sqrt(sum(power(Q1+Q2,2)));
    Q13MAG=sqrt(sum(power(Q1+Q3,2)));
    Q14MAG=sqrt(sum(power(Q1+Q4,2)));
    Q23MAG=sqrt(sum(power(Q2+Q3,2)));
    Q24MAG=sqrt(sum(power(Q2+Q4,2)));
    Q34MAG=sqrt(sum(power(Q3+Q4,2)));

    R12=-Q12MAG*Q12MAG/(2*d);
    R13=-Q13MAG*Q13MAG/(2*d);
    R14=-Q14MAG*Q14MAG/(2*d);
    R23=-Q23MAG*Q23MAG/(2*d);
    R24=-Q24MAG*Q24MAG/(2*d);
    R34=-Q34MAG*Q34MAG/(2*d);
    
    Z1=exp(R1*NM);
    Z2=exp(R2*NM);
    Z3=exp(R3*NM);
    Z4=exp(R4*NM);
    
    Z12=exp(R12*NM);
    Z13=exp(R13*NM);
    Z14=exp(R14*NM);
    Z23=exp(R23*NM);
    Z24=exp(R24*NM);
    Z34=exp(R34*NM);

    Z1L=exp(R1*NM)*LAM;
    Z2L=exp(R2*NM)*LAM;
    Z3L=exp(R3*NM)*LAM;
    Z4L=exp(R4*NM)*LAM;
    
    Z12L=exp(R12*NM)*LAM;
    Z14L=exp(R14*NM)*LAM;
    Z13L=exp(R13*NM)*LAM;
    Z23L=exp(R23*NM)*LAM;
    Z24L=exp(R24*NM)*LAM;
    Z34L=exp(R34*NM)*LAM;
    
    % PERMUTATIONS
    % 1 12 4 112 443
    % 1 12 3 112 334
    % 1 13 4 113 442
    % 1 13 2 113 224
    % 1 14 3 114 332
    % 1 14 2 114 223
    % 2 23 4 223 441
    % 2 23 1 223 114
    % 2 24 3 224 331
    % 2 24 1 224 113
    % 3 34 2 334 221
    % 3 34 1 334 112
    CasesIncluded=[0,0,0,0,0,0,0,1];
    %              1 2 3 4 5 6 7 8
    
    if CasesIncluded(1)
    % Case 1: J1==J2==J3==J4
        S4=case1(S4,N,NM,R1,R12,R4,F,MIN);
        S4=case1(S4,N,NM,R1,R12,R3,F,MIN);
        S4=case1(S4,N,NM,R1,R13,R4,F,MIN);
        S4=case1(S4,N,NM,R1,R13,R2,F,MIN);
        S4=case1(S4,N,NM,R1,R14,R3,F,MIN);
        S4=case1(S4,N,NM,R1,R14,R2,F,MIN);
        S4=case1(S4,N,NM,R2,R23,R4,F,MIN);
        S4=case1(S4,N,NM,R2,R23,R1,F,MIN);
        S4=case1(S4,N,NM,R2,R24,R3,F,MIN);
        S4=case1(S4,N,NM,R2,R24,R1,F,MIN);
        S4=case1(S4,N,NM,R3,R34,R2,F,MIN);
        S4=case1(S4,N,NM,R3,R34,R1,F,MIN);
    end
    if CasesIncluded(2)
    % Case 2: J1 <J2==J3==J4 (4 subcases)
        % J1 <J2==J3==J4 (six terms)
        SDEL=zeros(2,2,2,2);
        SDEL(1,1,1,1)=1;
        SDEL(2,2,2,2)=1;
        SDEL(2,1,1,1)=1;
        SDEL(1,2,2,2)=1;
        %total of six terms
        S4=case2(S4,N,NM,R1,R12,R4,Z1,Z1L,F,DF,SDEL,1,2,MIN);
        S4=case2(S4,N,NM,R1,R12,R3,Z1,Z1L,F,DF,SDEL,1,2,MIN);
        S4=case2(S4,N,NM,R1,R13,R4,Z1,Z1L,F,DF,SDEL,1,3,MIN);
        S4=case2(S4,N,NM,R1,R13,R2,Z1,Z1L,F,DF,SDEL,1,3,MIN);
        S4=case2(S4,N,NM,R1,R14,R3,Z1,Z1L,F,DF,SDEL,1,4,MIN);
        S4=case2(S4,N,NM,R1,R14,R2,Z1,Z1L,F,DF,SDEL,1,4,MIN);
        
        % J2 <J1==J3==J4
        SDEL=zeros(2,2,2,2);
        SDEL(1,1,1,1)=1;
        SDEL(2,2,2,2)=1;
        SDEL(1,2,1,1)=1;
        SDEL(2,1,2,2)=1;
        S4=case2(S4,N,NM,R2,R12,R3,Z2,Z2L,F,DF,SDEL,2,1,MIN);
        S4=case2(S4,N,NM,R2,R12,R4,Z2,Z2L,F,DF,SDEL,2,1,MIN);
        S4=case2(S4,N,NM,R2,R23,R1,Z2,Z2L,F,DF,SDEL,2,3,MIN);
        S4=case2(S4,N,NM,R2,R23,R4,Z2,Z2L,F,DF,SDEL,2,3,MIN);
        S4=case2(S4,N,NM,R2,R24,R1,Z2,Z2L,F,DF,SDEL,2,4,MIN);
        S4=case2(S4,N,NM,R2,R24,R3,Z2,Z2L,F,DF,SDEL,2,4,MIN);

        % J3 <J1==J2==J4
        SDEL=zeros(2,2,2,2);
        SDEL(1,1,1,1)=1;
        SDEL(2,2,2,2)=1;
        SDEL(1,1,2,1)=1;
        SDEL(2,2,1,2)=1;
        S4=case2(S4,N,NM,R3,R13,R2,Z2,Z2L,F,DF,SDEL,3,1,MIN);
        S4=case2(S4,N,NM,R3,R13,R4,Z2,Z2L,F,DF,SDEL,3,1,MIN);
        S4=case2(S4,N,NM,R3,R23,R1,Z2,Z2L,F,DF,SDEL,3,2,MIN);
        S4=case2(S4,N,NM,R3,R23,R4,Z2,Z2L,F,DF,SDEL,3,2,MIN);
        S4=case2(S4,N,NM,R3,R34,R1,Z2,Z2L,F,DF,SDEL,3,4,MIN);
        S4=case2(S4,N,NM,R3,R34,R2,Z2,Z2L,F,DF,SDEL,3,4,MIN);

        % J4 <J1==J2==J3
        SDEL=zeros(2,2,2,2);
        SDEL(1,1,1,1)=1;
        SDEL(2,2,2,2)=1;
        SDEL(1,1,1,2)=1;
        SDEL(2,2,2,1)=1;
        S4=case2(S4,N,NM,R4,R14,R2,Z2,Z2L,F,DF,SDEL,4,1,MIN);
        S4=case2(S4,N,NM,R4,R14,R3,Z2,Z2L,F,DF,SDEL,4,1,MIN);
        S4=case2(S4,N,NM,R4,R24,R1,Z2,Z2L,F,DF,SDEL,4,2,MIN);
        S4=case2(S4,N,NM,R4,R24,R3,Z2,Z2L,F,DF,SDEL,4,2,MIN);
        S4=case2(S4,N,NM,R4,R34,R1,Z2,Z2L,F,DF,SDEL,4,3,MIN);
        S4=case2(S4,N,NM,R4,R34,R2,Z2,Z2L,F,DF,SDEL,4,3,MIN);
    end
    if CasesIncluded(3)
    % Case 3: J1==J2 <J3==J4 (3 subcases)
        % J1=J2<J3=J4 // J2=J1<J3=J4 // J1=J2<J4=J3 // J2=J1<J4=J3
        SDEL=zeros(2,2,2,2);
        SDEL(1,1,1,1)=1;
        SDEL(2,2,2,2)=1;
        SDEL(1,1,2,2)=1;
        SDEL(2,2,1,1)=1;
        S4=case3(S4,N,NM,R1,R12,R4,Z12,Z12L,F,DF,SDEL,2,3,MIN);
        S4=case3(S4,N,NM,R2,R12,R4,Z12,Z12L,F,DF,SDEL,1,3,MIN);
        S4=case3(S4,N,NM,R1,R12,R3,Z12,Z12L,F,DF,SDEL,2,4,MIN);
        S4=case3(S4,N,NM,R2,R12,R3,Z12,Z12L,F,DF,SDEL,1,4,MIN);
        % J3=J4<J1=J2 // J4=J3<J1=J2 // J3=J4<J2=J1 // J4=J3<J2=J1
        S4=case3(S4,N,NM,R3,R34,R2,Z34,Z34L,F,DF,SDEL,4,1,MIN);
        S4=case3(S4,N,NM,R4,R34,R2,Z34,Z34L,F,DF,SDEL,3,1,MIN);
        S4=case3(S4,N,NM,R3,R34,R1,Z34,Z34L,F,DF,SDEL,4,2,MIN);
        S4=case3(S4,N,NM,R4,R34,R1,Z34,Z34L,F,DF,SDEL,3,2,MIN);
        
        % J1=J3<J2=J4 // J3=J1<J2=J4 // J1=J3<J4=J2 // J3=J1<J4=J2
        SDEL=zeros(2,2,2,2);
        SDEL(1,1,1,1)=1;
        SDEL(2,2,2,2)=1;
        SDEL(1,2,1,2)=1;
        SDEL(2,1,2,1)=1;
        S4=case3(S4,N,NM,R1,R13,R4,Z13,Z13L,F,DF,SDEL,3,2,MIN);
        S4=case3(S4,N,NM,R3,R13,R4,Z13,Z13L,F,DF,SDEL,1,2,MIN);
        S4=case3(S4,N,NM,R1,R13,R2,Z13,Z13L,F,DF,SDEL,3,4,MIN);
        S4=case3(S4,N,NM,R3,R13,R2,Z13,Z13L,F,DF,SDEL,1,4,MIN);
        % J2=J4<J1=J3 // J2=J4<J3=J1 // J4=J2<J1=J3 // J4=J2<J3=J1
        S4=case3(S4,N,NM,R2,R24,R3,Z24,Z24L,F,DF,SDEL,4,1,MIN);
        S4=case3(S4,N,NM,R2,R24,R1,Z24,Z24L,F,DF,SDEL,4,3,MIN);
        S4=case3(S4,N,NM,R4,R24,R3,Z24,Z24L,F,DF,SDEL,2,1,MIN);
        S4=case3(S4,N,NM,R4,R24,R1,Z24,Z24L,F,DF,SDEL,2,3,MIN);

        % J1=J4<J2=J3 // J4=J1<J2=J3 // J1=J4<J3=J2 // J4=J1<J3=J2
        SDEL=zeros(2,2,2,2);
        SDEL(1,1,1,1)=1;
        SDEL(2,2,2,2)=1;
        SDEL(1,2,2,1)=1;
        SDEL(2,1,1,2)=1;
        % J2=J3<J1=J4 // J3=J2<J1=J4 // J2=J3<J4=J1 // J3=J2<J4=J1
        S4=case3(S4,N,NM,R2,R23,R4,Z23,Z23L,F,DF,SDEL,3,1,MIN);
        S4=case3(S4,N,NM,R3,R23,R4,Z23,Z23L,F,DF,SDEL,2,1,MIN);
        S4=case3(S4,N,NM,R2,R23,R1,Z23,Z23L,F,DF,SDEL,3,4,MIN);
        S4=case3(S4,N,NM,R3,R23,R1,Z23,Z23L,F,DF,SDEL,2,4,MIN);
        % J1=J4<J2=J3 // J1=J4<J3=J2 // J4=J1<J2=J3 // J4=J1<J3=J2
        S4=case3(S4,N,NM,R1,R14,R3,Z14,Z14L,F,DF,SDEL,4,2,MIN);
        S4=case3(S4,N,NM,R1,R14,R2,Z14,Z14L,F,DF,SDEL,4,3,MIN);
        S4=case3(S4,N,NM,R4,R14,R3,Z14,Z14L,F,DF,SDEL,1,2,MIN);
        S4=case3(S4,N,NM,R4,R14,R2,Z14,Z14L,F,DF,SDEL,1,3,MIN);
    end
    if CasesIncluded(4)
    % Case 4: J1==J2==J3 <J4 (4 subcases)
        % J1==J2==J3 <J4 (six terms)
        SDEL=zeros(2,2,2,2);
        SDEL(1,1,1,1)=1;
        SDEL(2,2,2,2)=1;
        SDEL(1,1,1,2)=1;
        SDEL(2,2,2,1)=1;
        S4=case4(S4,N,NM,R1,R12,R4,Z4,Z4L,F,DF,SDEL,3,4,MIN);
        S4=case4(S4,N,NM,R1,R13,R4,Z4,Z4L,F,DF,SDEL,2,4,MIN);
        S4=case4(S4,N,NM,R2,R12,R4,Z4,Z4L,F,DF,SDEL,3,4,MIN);
        S4=case4(S4,N,NM,R2,R23,R4,Z4,Z4L,F,DF,SDEL,1,4,MIN);
        S4=case4(S4,N,NM,R3,R13,R4,Z4,Z4L,F,DF,SDEL,2,4,MIN);
        S4=case4(S4,N,NM,R3,R23,R4,Z4,Z4L,F,DF,SDEL,1,4,MIN);    
    
        % J1==J2==J4 <J3
        SDEL=zeros(2,2,2,2);
        SDEL(1,1,1,1)=1;
        SDEL(2,2,2,2)=1;
        SDEL(1,1,2,1)=1;
        SDEL(2,2,1,2)=1;
        S4=case4(S4,N,NM,R1,R12,R3,Z3,Z3L,F,DF,SDEL,4,3,MIN);
        S4=case4(S4,N,NM,R1,R14,R3,Z3,Z3L,F,DF,SDEL,2,3,MIN);
        S4=case4(S4,N,NM,R2,R12,R3,Z3,Z3L,F,DF,SDEL,4,3,MIN);
        S4=case4(S4,N,NM,R2,R24,R3,Z3,Z3L,F,DF,SDEL,1,3,MIN);
        S4=case4(S4,N,NM,R4,R14,R3,Z3,Z3L,F,DF,SDEL,2,3,MIN);
        S4=case4(S4,N,NM,R4,R24,R3,Z3,Z3L,F,DF,SDEL,1,3,MIN);
        
        % J1==J3==J4 <J2
        SDEL=zeros(2,2,2,2);
        SDEL(1,1,1,1)=1;
        SDEL(2,2,2,2)=1;
        SDEL(1,2,1,1)=1;
        SDEL(2,1,2,2)=1;
        S4=case4(S4,N,NM,R1,R13,R2,Z2,Z2L,F,DF,SDEL,4,2,MIN);
        S4=case4(S4,N,NM,R1,R14,R2,Z2,Z2L,F,DF,SDEL,3,2,MIN);
        S4=case4(S4,N,NM,R3,R13,R2,Z2,Z2L,F,DF,SDEL,4,2,MIN);
        S4=case4(S4,N,NM,R3,R34,R2,Z2,Z2L,F,DF,SDEL,1,2,MIN);
        S4=case4(S4,N,NM,R4,R14,R2,Z2,Z2L,F,DF,SDEL,3,2,MIN);
        S4=case4(S4,N,NM,R4,R34,R2,Z2,Z2L,F,DF,SDEL,1,2,MIN);

        % J2==J3==J4 <J1
        SDEL=zeros(2,2,2,2);
        SDEL(1,1,1,1)=1;
        SDEL(2,2,2,2)=1;
        SDEL(2,1,1,1)=1;
        SDEL(1,2,2,2)=1;
        S4=case4(S4,N,NM,R2,R23,R1,Z1,Z1L,F,DF,SDEL,4,1,MIN);
        S4=case4(S4,N,NM,R2,R24,R1,Z1,Z1L,F,DF,SDEL,3,1,MIN);
        S4=case4(S4,N,NM,R3,R23,R1,Z1,Z1L,F,DF,SDEL,4,1,MIN);
        S4=case4(S4,N,NM,R3,R34,R1,Z1,Z1L,F,DF,SDEL,2,1,MIN);
        S4=case4(S4,N,NM,R4,R24,R1,Z1,Z1L,F,DF,SDEL,3,1,MIN);
        S4=case4(S4,N,NM,R4,R34,R1,Z1,Z1L,F,DF,SDEL,2,1,MIN);
    end
    if CasesIncluded(5)
    % Case 5: J1 <J2 <J3==J4 (six subcases)
        % J1 <J2 <J3==J4 (two terms)
        SDEL=zeros(2,2,2,2);
        SDEL(1,1,1,1)=1;
        SDEL(2,2,2,2)=1;
        SDEL(2,1,1,1)=1;
        SDEL(1,2,1,1)=1;
        SDEL(2,2,1,1)=1;
        SDEL(1,2,2,2)=1;
        SDEL(2,1,2,2)=1;
        SDEL(1,1,2,2)=1;
        S4=case5(S4,N,NM,R1,R12,R4,Z1,Z1L,Z12,Z12L,F,DF,SDEL,1,2,3,MIN);
        S4=case5(S4,N,NM,R1,R12,R3,Z1,Z1L,Z12,Z12L,F,DF,SDEL,1,2,4,MIN);
        % J2 <J1 <J3==J4
        S4=case5(S4,N,NM,R2,R12,R4,Z1,Z2L,Z12,Z12L,F,DF,SDEL,2,1,3,MIN);
        S4=case5(S4,N,NM,R2,R12,R3,Z1,Z2L,Z12,Z12L,F,DF,SDEL,2,1,4,MIN);
        
        % J1 <J3 <J2==J4 (two terms)
        SDEL=zeros(2,2,2,2);
        SDEL(1,1,1,1)=1;
        SDEL(2,2,2,2)=1;
        SDEL(2,1,1,1)=1;
        SDEL(1,1,2,1)=1;
        SDEL(2,1,2,1)=1;
        SDEL(1,2,2,2)=1;
        SDEL(2,2,1,2)=1;
        SDEL(1,2,1,2)=1;
        S4=case5(S4,N,NM,R1,R13,R4,Z1,Z1L,Z13,Z13L,F,DF,SDEL,1,3,2,MIN);
        S4=case5(S4,N,NM,R1,R13,R2,Z1,Z1L,Z13,Z13L,F,DF,SDEL,1,3,4,MIN);
        % J3 <J1 <J2==J4
        S4=case5(S4,N,NM,R3,R13,R4,Z3,Z3L,Z13,Z13L,F,DF,SDEL,3,1,2,MIN);
        S4=case5(S4,N,NM,R3,R13,R2,Z3,Z3L,Z13,Z13L,F,DF,SDEL,3,1,4,MIN);
        
        % J2 <J3 <J1==J4 (two terms)
        SDEL=zeros(2,2,2,2);
        SDEL(1,1,1,1)=1;
        SDEL(2,2,2,2)=1;
        SDEL(1,1,2,1)=1;
        SDEL(1,2,1,1)=1;
        SDEL(1,2,2,1)=1;
        SDEL(2,1,2,2)=1;
        SDEL(2,2,1,2)=1;
        SDEL(2,1,1,2)=1;
        S4=case5(S4,N,NM,R2,R23,R4,Z2,Z2L,Z23,Z23L,F,DF,SDEL,2,3,1,MIN);
        S4=case5(S4,N,NM,R2,R23,R1,Z2,Z2L,Z23,Z23L,F,DF,SDEL,2,3,4,MIN);
        % J3 <J2 <J1==J4
        S4=case5(S4,N,NM,R3,R23,R4,Z3,Z3L,Z23,Z23L,F,DF,SDEL,3,2,1,MIN);
        S4=case5(S4,N,NM,R3,R23,R1,Z3,Z3L,Z23,Z23L,F,DF,SDEL,3,2,4,MIN);

        % J1 <J4 <J2==J3 (two terms)
        SDEL=zeros(2,2,2,2);
        SDEL(1,1,1,1)=1;
        SDEL(2,2,2,2)=1;
        SDEL(2,1,1,1)=1;
        SDEL(1,1,1,2)=1;
        SDEL(2,1,1,2)=1;
        SDEL(1,2,2,2)=1;
        SDEL(2,2,2,1)=1;
        SDEL(1,2,2,1)=1;
        S4=case5(S4,N,NM,R1,R14,R3,Z1,Z1L,Z14,Z14L,F,DF,SDEL,1,4,2,MIN);
        S4=case5(S4,N,NM,R1,R14,R2,Z1,Z1L,Z14,Z14L,F,DF,SDEL,1,4,3,MIN);
        % J4 <J1 <J2==J3
        S4=case5(S4,N,NM,R4,R14,R3,Z4,Z4L,Z14,Z14L,F,DF,SDEL,4,1,2,MIN);
        S4=case5(S4,N,NM,R4,R14,R2,Z4,Z4L,Z14,Z14L,F,DF,SDEL,4,1,3,MIN);
        
        % J2 <J4 <J1==J3 (two terms)
        SDEL=zeros(2,2,2,2);
        SDEL(1,1,1,1)=1;
        SDEL(2,2,2,2)=1;
        SDEL(1,2,1,1)=1;
        SDEL(1,1,1,2)=1;
        SDEL(1,2,1,2)=1;
        SDEL(2,2,2,1)=1;
        SDEL(2,1,2,2)=1;
        SDEL(2,1,2,1)=1;
        S4=case5(S4,N,NM,R2,R24,R3,Z2,Z2L,Z24,Z24L,F,DF,SDEL,2,4,1,MIN);
        S4=case5(S4,N,NM,R2,R24,R1,Z2,Z2L,Z24,Z24L,F,DF,SDEL,2,4,3,MIN);
        % J4 <J2 <J1==J3
        S4=case5(S4,N,NM,R4,R24,R3,Z4,Z4L,Z24,Z24L,F,DF,SDEL,4,2,1,MIN);
        S4=case5(S4,N,NM,R4,R24,R1,Z4,Z4L,Z24,Z24L,F,DF,SDEL,4,2,3,MIN);
        
        % J3 <J4 <J1==J2 (two terms)
        SDEL=zeros(2,2,2,2);
        SDEL(1,1,1,1)=1;
        SDEL(2,2,2,2)=1;
        SDEL(1,1,2,1)=1;
        SDEL(1,1,1,2)=1;
        SDEL(1,1,2,2)=1;
        SDEL(2,2,2,1)=1;
        SDEL(2,2,1,2)=1;
        SDEL(2,2,1,1)=1;
        S4=case5(S4,N,NM,R3,R34,R2,Z3,Z3L,Z34,Z34L,F,DF,SDEL,3,4,1,MIN);
        S4=case5(S4,N,NM,R3,R34,R1,Z3,Z3L,Z34,Z34L,F,DF,SDEL,3,4,2,MIN);
        % J4 <J3 <J1==J2
        S4=case5(S4,N,NM,R4,R34,R2,Z4,Z4L,Z34,Z34L,F,DF,SDEL,4,3,1,MIN);
        S4=case5(S4,N,NM,R4,R34,R1,Z4,Z4L,Z34,Z34L,F,DF,SDEL,4,3,2,MIN);
    end
    if CasesIncluded(6)
    % Case 6: J1==J2 <J3 <J4 (six subterms)
        % J1==J2 <J3 <J4 (two terms)
        SDEL=zeros(2,2,2,2);
        SDEL(1,1,1,1)=1;
        SDEL(2,2,2,2)=1;
        SDEL(1,1,1,2)=1;
        SDEL(1,1,2,1)=1;
        SDEL(1,1,2,2)=1;
        SDEL(2,2,2,1)=1;
        SDEL(2,2,1,2)=1;
        SDEL(2,2,1,1)=1;
        S4=case6(S4,N,NM,R1,R12,R4,Z12,Z12L,Z4,Z4L,F,DF,SDEL,2,3,4,MIN);
        S4=case6(S4,N,NM,R2,R12,R4,Z12,Z12L,Z4,Z4L,F,DF,SDEL,1,3,4,MIN);        
        % J1==J2 <J4 <J3
        S4=case6(S4,N,NM,R1,R12,R3,Z12,Z12L,Z3,Z3L,F,DF,SDEL,2,4,3,MIN);
        S4=case6(S4,N,NM,R2,R12,R3,Z12,Z12L,Z3,Z3L,F,DF,SDEL,1,4,3,MIN);
        
        % J1==J3 <J2 <J4 (two terms)
        SDEL=zeros(2,2,2,2);
        SDEL(1,1,1,1)=1;
        SDEL(2,2,2,2)=1;
        SDEL(1,1,1,2)=1;
        SDEL(1,2,1,1)=1;
        SDEL(1,2,1,2)=1;
        SDEL(2,2,2,1)=1;
        SDEL(2,1,2,2)=1;
        SDEL(2,1,2,1)=1;
        S4=case6(S4,N,NM,R1,R13,R4,Z13,Z13L,Z4,Z4L,F,DF,SDEL,3,2,4,MIN);
        S4=case6(S4,N,NM,R3,R13,R4,Z13,Z13L,Z4,Z4L,F,DF,SDEL,1,2,4,MIN);
        % J1==J3 <J4 <J2
        S4=case6(S4,N,NM,R1,R13,R2,Z13,Z13L,Z2,Z2L,F,DF,SDEL,3,4,2,MIN);
        S4=case6(S4,N,NM,R3,R13,R2,Z13,Z13L,Z2,Z2L,F,DF,SDEL,1,4,2,MIN);
        
        % J1==J4 <J2 <J3 (two terms)
        SDEL=zeros(2,2,2,2);
        SDEL(1,1,1,1)=1;
        SDEL(2,2,2,2)=1;
        SDEL(1,1,2,1)=1;
        SDEL(1,2,1,1)=1;
        SDEL(1,2,2,1)=1;
        SDEL(2,2,1,2)=1;
        SDEL(2,1,2,2)=1;
        SDEL(2,1,1,2)=1;
        S4=case6(S4,N,NM,R1,R14,R3,Z14,Z14L,Z3,Z3L,F,DF,SDEL,4,2,3,MIN);
        S4=case6(S4,N,NM,R4,R14,R3,Z14,Z14L,Z3,Z3L,F,DF,SDEL,1,2,3,MIN);
        % J1==J4 <J3 <J2
        S4=case6(S4,N,NM,R1,R14,R2,Z14,Z14L,Z2,Z2L,F,DF,SDEL,4,3,2,MIN);
        S4=case6(S4,N,NM,R4,R14,R2,Z14,Z14L,Z2,Z2L,F,DF,SDEL,1,3,2,MIN);
        
        % J2==J3 <J1 <J4 (two terms)
        SDEL=zeros(2,2,2,2);
        SDEL(1,1,1,1)=1;
        SDEL(2,2,2,2)=1;
        SDEL(2,1,1,1)=1;
        SDEL(1,1,1,2)=1;
        SDEL(2,1,1,2)=1;
        SDEL(2,2,2,1)=1;
        SDEL(1,2,2,2)=1;
        SDEL(1,2,2,1)=1;
        S4=case6(S4,N,NM,R2,R23,R4,Z23,Z23L,Z4,Z4L,F,DF,SDEL,3,1,4,MIN);
        S4=case6(S4,N,NM,R3,R23,R4,Z23,Z23L,Z4,Z4L,F,DF,SDEL,2,1,4,MIN);
        % J2==J3 <J4 <J1
        S4=case6(S4,N,NM,R2,R23,R1,Z23,Z23L,Z1,Z1L,F,DF,SDEL,3,4,1,MIN);
        S4=case6(S4,N,NM,R3,R23,R1,Z23,Z23L,Z1,Z1L,F,DF,SDEL,2,4,1,MIN);
        
        % J2==J4 <J1 <J3 (two terms)
        SDEL=zeros(2,2,2,2);
        SDEL(1,1,1,1)=1;
        SDEL(2,2,2,2)=1;
        SDEL(2,1,1,1)=1;
        SDEL(1,1,2,1)=1;
        SDEL(2,1,2,1)=1;
        SDEL(1,2,2,2)=1;
        SDEL(2,2,1,2)=1;
        SDEL(1,2,1,2)=1;
        S4=case6(S4,N,NM,R2,R24,R3,Z24,Z24L,Z3,Z3L,F,DF,SDEL,4,1,3,MIN);
        S4=case6(S4,N,NM,R4,R24,R3,Z24,Z24L,Z3,Z3L,F,DF,SDEL,2,1,3,MIN);
        % J2==J4 <J3 <J1
        S4=case6(S4,N,NM,R2,R24,R1,Z24,Z24L,Z1,Z1L,F,DF,SDEL,4,3,1,MIN);
        S4=case6(S4,N,NM,R4,R24,R1,Z24,Z24L,Z1,Z1L,F,DF,SDEL,2,3,1,MIN);
        
        % J3==J4 <J1 <J2 (two terms)
        SDEL=zeros(2,2,2,2);
        SDEL(1,1,1,1)=1;
        SDEL(2,2,2,2)=1;
        SDEL(2,1,1,1)=1;
        SDEL(1,2,1,1)=1;
        SDEL(2,2,1,1)=1;
        SDEL(1,2,2,2)=1;
        SDEL(2,1,2,2)=1;
        SDEL(1,1,2,2)=1;
        S4=case6(S4,N,NM,R3,R34,R2,Z34,Z34L,Z2,Z2L,F,DF,SDEL,4,1,2,MIN);
        S4=case6(S4,N,NM,R4,R34,R2,Z34,Z34L,Z2,Z2L,F,DF,SDEL,3,1,2,MIN);        
        % J3==J4 <J2 <J1
        S4=case6(S4,N,NM,R3,R34,R1,Z34,Z34L,Z1,Z1L,F,DF,SDEL,4,2,1,MIN);
        S4=case6(S4,N,NM,R4,R34,R1,Z34,Z34L,Z1,Z1L,F,DF,SDEL,3,2,1,MIN);
    end
    if CasesIncluded(7)
    % Case 7: J1 <J2==J3 <J4 (six subcases)
        % J1 <J2==J3 <J4 (two terms)
        SDEL=zeros(2,2,2,2);
        SDEL(1,1,1,1)=1;
        SDEL(2,2,2,2)=1;
        SDEL(1,1,1,2)=1;
        SDEL(2,1,1,1)=1;
        SDEL(2,1,1,2)=1;
        SDEL(2,2,2,1)=1;
        SDEL(1,2,2,2)=1;
        SDEL(1,2,2,1)=1;
        S4=case7(S4,N,NM,R1,R12,R4,Z1,Z1L,Z4,Z4L,F,DF,SDEL,1,2,4,MIN);
        S4=case7(S4,N,NM,R1,R13,R4,Z1,Z1L,Z4,Z4L,F,DF,SDEL,1,3,4,MIN);
        % J4 <J2==J3 <J1
        S4=case7(S4,N,NM,R4,R12,R1,Z4,Z4L,Z1,Z1L,F,DF,SDEL,4,2,1,MIN);
        S4=case7(S4,N,NM,R4,R13,R1,Z4,Z4L,Z1,Z1L,F,DF,SDEL,4,3,1,MIN);
        
        % J1 <J2==J4 <J3 (two terms)
        SDEL=zeros(2,2,2,2);
        SDEL(1,1,1,1)=1;
        SDEL(2,2,2,2)=1;
        SDEL(2,1,1,1)=1;
        SDEL(1,1,2,1)=1;
        SDEL(2,1,2,1)=1;
        SDEL(1,2,2,2)=1;
        SDEL(2,2,1,2)=1;
        SDEL(1,2,1,2)=1;
        S4=case7(S4,N,NM,R1,R12,R3,Z1,Z1L,Z3,Z3L,F,DF,SDEL,1,2,3,MIN);
        S4=case7(S4,N,NM,R1,R14,R3,Z1,Z1L,Z3,Z3L,F,DF,SDEL,1,4,3,MIN);
        % J3 <J2==J4 <J1
        S4=case7(S4,N,NM,R3,R23,R1,Z3,Z3L,Z1,Z1L,F,DF,SDEL,3,2,1,MIN);
        S4=case7(S4,N,NM,R3,R34,R1,Z3,Z3L,Z1,Z1L,F,DF,SDEL,3,4,1,MIN);
        
        % J3 <J2==J1 <J4 (two terms)
        SDEL=zeros(2,2,2,2);
        SDEL(1,1,1,1)=1;
        SDEL(2,2,2,2)=1;
        SDEL(1,1,1,2)=1;
        SDEL(1,1,2,1)=1;
        SDEL(1,1,2,2)=1;
        SDEL(2,2,2,1)=1;
        SDEL(2,2,1,2)=1;
        SDEL(2,2,1,1)=1;
        S4=case7(S4,N,NM,R3,R23,R4,Z3,Z3L,Z4,Z4L,F,DF,SDEL,3,2,4,MIN);
        S4=case7(S4,N,NM,R3,R13,R4,Z3,Z3L,Z4,Z4L,F,DF,SDEL,3,1,4,MIN);
        % J4 <J2==J1 <J3
        S4=case7(S4,N,NM,R4,R24,R3,Z4,Z4L,Z3,Z3L,F,DF,SDEL,4,2,3,MIN);
        S4=case7(S4,N,NM,R4,R14,R3,Z4,Z4L,Z3,Z3L,F,DF,SDEL,4,1,3,MIN);
        
        % J2 <J1==J3 <J4 (two terms)
        SDEL=zeros(2,2,2,2);
        SDEL(1,1,1,1)=1;
        SDEL(2,2,2,2)=1;
        SDEL(1,1,1,2)=1;
        SDEL(1,2,1,1)=1;
        SDEL(1,2,1,2)=1;
        SDEL(2,2,2,1)=1;
        SDEL(2,1,2,2)=1;
        SDEL(2,1,2,1)=1;
        S4=case7(S4,N,NM,R2,R12,R4,Z2,Z2L,Z4,Z4L,F,DF,SDEL,2,1,4,MIN);
        S4=case7(S4,N,NM,R2,R13,R4,Z2,Z2L,Z4,Z4L,F,DF,SDEL,2,3,4,MIN);
        % J4 <J1==J3 <J2
        S4=case7(S4,N,NM,R4,R12,R2,Z4,Z4L,Z2,Z2L,F,DF,SDEL,4,1,2,MIN);
        S4=case7(S4,N,NM,R4,R13,R2,Z4,Z4L,Z2,Z2L,F,DF,SDEL,4,3,2,MIN);
        
        % J2 <J1==J4 <J3 (two terms)
        SDEL=zeros(2,2,2,2);
        SDEL(1,1,1,1)=1;
        SDEL(2,2,2,2)=1;
        SDEL(1,1,2,1)=1;
        SDEL(1,2,1,1)=1;
        SDEL(1,2,2,1)=1;
        SDEL(2,1,2,2)=1;
        SDEL(2,2,1,2)=1;
        SDEL(2,1,1,2)=1;
        S4=case7(S4,N,NM,R2,R12,R3,Z2,Z2L,Z3,Z3L,F,DF,SDEL,2,1,3,MIN);
        S4=case7(S4,N,NM,R2,R24,R3,Z2,Z2L,Z3,Z3L,F,DF,SDEL,2,4,3,MIN);
        % J3 <J1==J4 <J2
        S4=case7(S4,N,NM,R3,R13,R2,Z3,Z3L,Z2,Z2L,F,DF,SDEL,3,1,2,MIN);
        S4=case7(S4,N,NM,R3,R34,R2,Z3,Z3L,Z2,Z2L,F,DF,SDEL,3,4,2,MIN);
        
        % J1 <J3==J4 <J2 (two terms)
        SDEL=zeros(2,2,2,2);
        SDEL(1,1,1,1)=1;
        SDEL(2,2,2,2)=1;
        SDEL(2,1,1,1)=1;
        SDEL(1,2,1,1)=1;
        SDEL(2,2,1,1)=1;
        SDEL(1,2,2,2)=1;
        SDEL(1,2,2,2)=1;
        SDEL(1,1,2,2)=1;
        S4=case7(S4,N,NM,R1,R13,R2,Z1,Z1L,Z2,Z2L,F,DF,SDEL,1,3,2,MIN);
        S4=case7(S4,N,NM,R1,R14,R2,Z1,Z1L,Z2,Z2L,F,DF,SDEL,1,4,2,MIN);
        % J2 <J3==J4 <J1
        S4=case7(S4,N,NM,R2,R23,R1,Z2,Z2L,Z1,Z1L,F,DF,SDEL,2,3,1,MIN);
        S4=case7(S4,N,NM,R2,R24,R1,Z2,Z2L,Z1,Z1L,F,DF,SDEL,2,4,1,MIN);
    end
    if CasesIncluded(8)
    % Case 8: J1 <J2 <J3 <J4
        SDEL=ones(2,2,2,2);
        S4=case8(S4,N,NM,R1,R12,R4,Z1,Z1L,Z12,Z12L,Z4,Z4L,F,DF,SDEL,1,2,3,4,MIN);
        S4=case8(S4,N,NM,R1,R12,R3,Z1,Z1L,Z12,Z12L,Z3,Z3L,F,DF,SDEL,1,2,4,3,MIN);
        S4=case8(S4,N,NM,R1,R13,R4,Z1,Z1L,Z13,Z13L,Z4,Z4L,F,DF,SDEL,1,3,2,4,MIN);
        S4=case8(S4,N,NM,R1,R13,R2,Z1,Z1L,Z13,Z13L,Z2,Z2L,F,DF,SDEL,1,3,4,2,MIN);
        S4=case8(S4,N,NM,R1,R14,R3,Z1,Z1L,Z14,Z14L,Z3,Z3L,F,DF,SDEL,1,4,2,3,MIN);
        S4=case8(S4,N,NM,R1,R14,R2,Z1,Z1L,Z14,Z14L,Z2,Z2L,F,DF,SDEL,1,4,3,2,MIN);
        S4=case8(S4,N,NM,R2,R23,R4,Z2,Z2L,Z23,Z23L,Z4,Z4L,F,DF,SDEL,2,3,1,4,MIN);
        S4=case8(S4,N,NM,R2,R23,R1,Z2,Z2L,Z23,Z23L,Z1,Z1L,F,DF,SDEL,2,3,4,1,MIN);
        S4=case8(S4,N,NM,R2,R24,R3,Z2,Z2L,Z24,Z24L,Z3,Z3L,F,DF,SDEL,2,4,1,3,MIN);
        S4=case8(S4,N,NM,R2,R24,R1,Z2,Z2L,Z24,Z24L,Z1,Z1L,F,DF,SDEL,2,4,3,1,MIN);
        S4=case8(S4,N,NM,R3,R34,R2,Z3,Z3L,Z34,Z34L,Z2,Z2L,F,DF,SDEL,3,4,1,2,MIN);
        S4=case8(S4,N,NM,R3,R34,R1,Z3,Z3L,Z34,Z34L,Z1,Z1L,F,DF,SDEL,3,4,2,1,MIN);

        S4=case8(S4,N,NM,R2,R12,R4,Z2,Z2L,Z12,Z12L,Z4,Z4L,F,DF,SDEL,2,1,3,4,MIN);
        S4=case8(S4,N,NM,R2,R12,R3,Z2,Z2L,Z12,Z12L,Z3,Z3L,F,DF,SDEL,2,1,4,3,MIN);
        S4=case8(S4,N,NM,R3,R13,R4,Z3,Z3L,Z13,Z13L,Z4,Z4L,F,DF,SDEL,3,1,2,4,MIN);
        S4=case8(S4,N,NM,R3,R13,R2,Z3,Z3L,Z13,Z13L,Z2,Z2L,F,DF,SDEL,3,1,4,2,MIN);
        S4=case8(S4,N,NM,R4,R14,R3,Z4,Z4L,Z14,Z14L,Z3,Z3L,F,DF,SDEL,4,1,2,3,MIN);
        S4=case8(S4,N,NM,R4,R14,R2,Z4,Z4L,Z14,Z14L,Z2,Z2L,F,DF,SDEL,4,1,3,2,MIN);
        S4=case8(S4,N,NM,R3,R23,R4,Z3,Z3L,Z23,Z23L,Z4,Z4L,F,DF,SDEL,3,2,1,4,MIN);
        S4=case8(S4,N,NM,R3,R23,R1,Z3,Z3L,Z23,Z23L,Z1,Z1L,F,DF,SDEL,3,2,4,1,MIN);
        S4=case8(S4,N,NM,R4,R24,R3,Z4,Z4L,Z24,Z24L,Z3,Z3L,F,DF,SDEL,4,2,1,3,MIN);
        S4=case8(S4,N,NM,R4,R24,R1,Z4,Z4L,Z24,Z24L,Z1,Z1L,F,DF,SDEL,4,2,3,1,MIN);
        S4=case8(S4,N,NM,R4,R34,R2,Z4,Z4L,Z34,Z34L,Z2,Z2L,F,DF,SDEL,4,3,1,2,MIN);
        S4=case8(S4,N,NM,R4,R34,R1,Z4,Z4L,Z34,Z34L,Z1,Z1L,F,DF,SDEL,4,3,2,1,MIN);
    end
end
end

function S4=case1(S4,N,NM,R1,R12,R3,F,MIN)
% Case 1: J1==J2==J3==J4
    E1=R1;
    E12=R12;
    E3=R3;
    
    % on same monomer
    if (abs(E1-E12)<MIN && abs(E12-E3)<MIN)
       valeq=(1/2).*E1.^(-4).*((-2).*(3+E1.*NM)+exp(1).^(E1.*NM).*(6+E1.*NM.*(( ...
         -4)+E1.*NM)));
    elseif (abs(E1-E12)<MIN && abs(E12-E3)>=MIN)
        valeq=E1.^(-3).*(E1+(-1).*E3).^(-2).*E3.^(-2).*(2.*((-1)+exp(1).^(E1.* ...
          NM)).*E3.^3+(2+exp(1).^(E1.*NM)).*E1.^2.*E3.^2.*NM+E1.^3.*((-1)+ ...
          exp(1).^(E3.*NM)+(-1).*E3.*NM)+(-1).*E1.*E3.^2.*((-3)+E3.*NM+exp( ...
          1).^(E1.*NM).*(3+E3.*NM)));
    elseif (abs(E1-E3)<MIN && abs(E1-E12)>=MIN)
        valeq=E1.^(-3).*(E1+(-1).*E12).^(-2).*E12.^(-2).*(2.*((-1)+exp(1).^(E1.* ...
          NM)).*E12.^3+(2+exp(1).^(E1.*NM)).*E1.^2.*E12.^2.*NM+E1.^3.*((-1)+ ...
          exp(1).^(E12.*NM)+(-1).*E12.*NM)+(-1).*E1.*E12.^2.*((-3)+E12.*NM+ ...
          exp(1).^(E1.*NM).*(3+E12.*NM)));
    elseif (abs(E12-E3)<MIN && abs(E1-E3)>=MIN)
       valeq=E1.^(-2).*(E1+(-1).*E12).^(-2).*E12.^(-3).*(((-1)+exp(1).^(E1.*NM) ...
          ).*E12.^3+(-1).*E1.*E12.^3.*NM+E1.^2.*E12.*(3+2.*E12.*NM+exp(1).^( ...
          E12.*NM).*((-3)+E12.*NM))+(-1).*E1.^3.*(2+E12.*NM+exp(1).^(E12.* ...
          NM).*((-2)+E12.*NM)));
    else
       valeq=E1.^(-2).*(E1+(-1).*E12).^(-1).*E12.^(-2).*(E1+(-1).*E3).^(-1).*( ...
          E12+(-1).*E3).^(-1).*E3.^(-2).*(((-1)+exp(1).^(E1.*NM)).*E12.^2.*( ...
          E12+(-1).*E3).*E3.^2+E1.*E12.^2.*E3.^2.*((-1).*E12+E3).*NM+E1.^3.* ...
          ((-1).*((-1)+exp(1).^(E12.*NM)).*E3.^2+E12.*E3.^2.*NM+E12.^2.*(( ...
          -1)+exp(1).^(E3.*NM)+(-1).*E3.*NM))+E1.^2.*(((-1)+exp(1).^(E12.* ...
          NM)).*E3.^3+(-1).*E12.*E3.^3.*NM+E12.^3.*(1+(-1).*exp(1).^(E3.*NM) ...
          +E3.*NM)));
    end
    valeq=finite(valeq);
    
    S4(1,1,1,1)=S4(1,1,1,1)+2*F(1)*N*valeq;
    S4(2,2,2,2)=S4(2,2,2,2)+2*F(2)*N*valeq;
end

function S4=case2(S4,N,NM,R1,R12,R3,Z1,Z1L,F,DF,SDEL,A1,A2,MIN)
% Case 2: J1 <J2==J3==J4
    E1=R1;
    E12=R12;
    E3=R3;
    ZE1=Z1;
    ZE1L=Z1L;
    
    % on same monomer
    if (abs(E1-E12)<MIN && abs(E12-E3)<MIN)
       valeq=(1/2).*(exp(1).^E1).^((-1).*NM).*((-1)+(exp(1).^E1).^NM).*log(exp( ...
       1).^E1).^(-4).*((-2)+(exp(1).^E1).^NM.*(2+NM.*log(exp(1).^E1).*(( ...
       -2)+NM.*log(exp(1).^E1))));
    elseif abs(E1-E12)<MIN
       valeq=(exp(1).^E1).^((-1).*NM).*((-1)+(exp(1).^E1).^NM).*log(exp(1).^E1) ...
       .^(-1).*(log(exp(1).^E1)+(-1).*log(exp(1).^E3)).^(-2).*(((-1)+( ...
       exp(1).^E1).^NM).*log(exp(1).^E1).^(-2).*log(exp(1).^E3)+log(exp( ...
       1).^E1).^(-1).*(2+(-2).*(exp(1).^E1).^NM+(-1).*(exp(1).^E1).^NM.* ...
       NM.*log(exp(1).^E3))+log(exp(1).^E3).^(-1).*((-1)+(exp(1).^E3) ...
       .^NM+(exp(1).^E1).^NM.*NM.*log(exp(1).^E3)));
    elseif abs(E1-E3)<MIN
       valeq=(exp(1).^E1).^((-1).*NM).*((-1)+(exp(1).^E1).^NM).*log(exp(1).^E1) ...
       .^(-1).*(log(exp(1).^E1)+(-1).*log(exp(1).^E12)).^(-2).*(((-1)+( ...
       exp(1).^E1).^NM).*log(exp(1).^E1).^(-2).*log(exp(1).^E12)+log(exp( ...
       1).^E1).^(-1).*(2+(-2).*(exp(1).^E1).^NM+(-1).*(exp(1).^E1).^NM.* ...
       NM.*log(exp(1).^E12))+log(exp(1).^E12).^(-1).*((-1)+(exp(1).^E12) ...
       .^NM+(exp(1).^E1).^NM.*NM.*log(exp(1).^E12)));
    elseif abs(E12-E3)<MIN
       valeq=(exp(1).^E1).^((-1).*NM).*((-1)+(exp(1).^E1).^NM).*log(exp(1).^E1) ...
       .^(-1).*(log(exp(1).^E1)+(-1).*log(exp(1).^E12)).^(-2).*(((-1)+( ...
       exp(1).^E1).^NM).*log(exp(1).^E1).^(-1)+log(exp(1).^E12).^(-2).*( ...
       log(exp(1).^E1).*((-1)+(exp(1).^E12).^NM+(-1).*(exp(1).^E12).^NM.* ...
       NM.*log(exp(1).^E12))+log(exp(1).^E12).*(2+(-2).*(exp(1).^E12) ...
       .^NM+(exp(1).^E12).^NM.*NM.*log(exp(1).^E12))));
    else
       valeq=(exp(1).^E1).^((-1).*NM).*((-1)+(exp(1).^E1).^NM).*log(exp(1).^E1) ...
       .^(-2).*(log(exp(1).^E1)+(-1).*log(exp(1).^E12)).^(-1).*log(exp(1) ...
       .^E12).^(-1).*(log(exp(1).^E1)+(-1).*log(exp(1).^E3)).^(-1).*(log( ...
       exp(1).^E12)+(-1).*log(exp(1).^E3)).^(-1).*log(exp(1).^E3).^(-1).* ...
       (((-1)+(exp(1).^E1).^NM).*log(exp(1).^E12).*(log(exp(1).^E12)+(-1) ...
       .*log(exp(1).^E3)).*log(exp(1).^E3)+log(exp(1).^E1).^2.*(((-1)+( ...
       exp(1).^E3).^NM).*log(exp(1).^E12)+(-1).*((-1)+(exp(1).^E12).^NM) ...
       .*log(exp(1).^E3))+log(exp(1).^E1).*((-1).*((-1)+(exp(1).^E3).^NM) ...
       .*log(exp(1).^E12).^2+((-1)+(exp(1).^E12).^NM).*log(exp(1).^E3) ...
       .^2));
    end
    
    % on different monomers
    valne1=(-1).*((-1)+ZE1).^(-2).*ZE1.*(1+N.*((-1)+ZE1)+(-1).*ZE1.^N);
    valne2=(-1).*((-1)+ZE1L).^(-2).*ZE1L.*(1+N.*((-1)+ZE1L)+(-1).*ZE1L.^N);
    valeq=finite(valeq);
    valne1=finite(valne1);
    valne2=finite(valne2);
    
    for I1=1:2
        for I2=1:2
            for I3=1:2
                for I4=1:2
                    FV=[F(I1),F(I2),F(I3),F(I4)];
                    DFV=[DF(I1),DF(I2),DF(I3),DF(I4)];
                    S4(I1,I2,I3,I4)=S4(I1,I2,I3,I4)+SDEL(I1,I2,I3,I4)*...
                      valeq*(FV(A1)*FV(A2)*valne1+...
                         FV(A1)*DFV(A1)*DFV(A2)*(1-FV(A1))*valne2);
                end
            end
        end
    end
end

function S4=case3(S4,N,NM,R1,R12,R3,Z12,Z12L,F,DF,SDEL,A2,A3,MIN)
% Case 3: J1==J2 <J3==J4
    E1=R1;
    E12=R12;
    E3=R3;
    ZE12=Z12;
    ZE12L=Z12L;

    % on same monomer
    if (abs(E1-E12)<MIN && abs(E12-E3)<MIN)
       valeq=(exp(1).^E1).^((-1).*NM).*log(exp(1).^E1).^(-4).*(1+(exp(1).^E1) ...
       .^NM.*((-1)+NM.*log(exp(1).^E1))).^2;
    elseif abs(E1-E12)<MIN
       valeq=(exp(1).^E1).^((-1).*NM).*log(exp(1).^E1).^(-2).*(1+(exp(1).^E1) ...
       .^NM.*((-1)+NM.*log(exp(1).^E1))).*(((-1)+(exp(1).^E1).^NM).*log( ...
       exp(1).^E1).^(-1)+(1+(-1).*(exp(1).^E3).^NM).*log(exp(1).^E3).^( ...
       -1)).*(log(exp(1).^E1)+(-1).*log(exp(1).^E3)).^(-1);
    elseif abs(E1-E3)<MIN
       valeq=(exp(1).^E12).^((-1).*NM).*log(exp(1).^E1).^(-2).*(log(exp(1).^E1) ...
       +(-1).*log(exp(1).^E12)).^(-2).*log(exp(1).^E12).^(-2).*(((-1)+( ...
       exp(1).^E12).^NM).*log(exp(1).^E1)+(-1).*((-1)+(exp(1).^E1).^NM).* ...
       log(exp(1).^E12)).^2;
    elseif abs(E12-E3)<MIN
       valeq=log(exp(1).^E1).^(-1).*(log(exp(1).^E1)+(-1).*log(exp(1).^E12)).^( ...
       -1).*log(exp(1).^E12).^(-3).*((-1).*((-1)+(exp(1).^E12).^NM).*log( ...
       exp(1).^E1)+((-1)+(exp(1).^E1).^NM).*log(exp(1).^E12)).*((-1)+( ...
       exp(1).^E12).^((-1).*NM)+NM.*log(exp(1).^E12));
    else
       valeq=(-1).*(exp(1).^E12).^((-1).*NM).*log(exp(1).^E1).^(-1).*(log(exp( ...
       1).^E1)+(-1).*log(exp(1).^E12)).^(-1).*log(exp(1).^E12).^(-1).*((( ...
       -1)+(exp(1).^E12).^NM).*log(exp(1).^E1)+(-1).*((-1)+(exp(1).^E1) ...
       .^NM).*log(exp(1).^E12)).*(((-1)+(exp(1).^E12).^NM).*log(exp(1) ...
       .^E12).^(-1)+(1+(-1).*(exp(1).^E3).^NM).*log(exp(1).^E3).^(-1)).*( ...
       log(exp(1).^E12)+(-1).*log(exp(1).^E3)).^(-1);
    end
    
    % on different monomers
    valne1=(-1).*((-1)+ZE12).^(-2).*ZE12.*(1+N.*((-1)+ZE12)+(-1).*ZE12.^N);
    valne2=(-1).*((-1)+ZE12L).^(-2).*ZE12L.*(1+N.*((-1)+ZE12L)+(-1).*ZE12L.^N);
    valeq=finite(valeq);
    valne1=finite(valne1);
    valne2=finite(valne2);
    
    for I1=1:2
        for I2=1:2
            for I3=1:2
                for I4=1:2
                    FV=[F(I1),F(I2),F(I3),F(I4)];
                    DFV=[DF(I1),DF(I2),DF(I3),DF(I4)];
                    S4(I1,I2,I3,I4)=S4(I1,I2,I3,I4)+SDEL(I1,I2,I3,I4)*...
                      valeq*(FV(A2)*FV(A3)*valne1+...
                         FV(A2)*DFV(A2)*DFV(A3)*(1-FV(A2))*valne2);
                end
            end
        end
    end
end

function S4=case4(S4,N,NM,R1,R12,R3,Z3,Z3L,F,DF,SDEL,A3,A4,MIN)
    E1=R1;
    E12=R12;
    E3=R3;
    ZE3=Z3;
    ZE3L=Z3L;
    
    % on same monomer
    if (abs(E1-E12)<MIN && abs(E12-E3)<MIN)
       valeq=(1/2).*(exp(1).^E1).^((-1).*NM).*((-1)+(exp(1).^E1).^NM).*log(exp( ...
       1).^E1).^(-4).*((-2)+(exp(1).^E1).^NM.*(2+NM.*log(exp(1).^E1).*(( ...
       -2)+NM.*log(exp(1).^E1))));
    elseif abs(E1-E12)<MIN
       valeq=(1+(-1).*(exp(1).^E3).^((-1).*NM)).*log(exp(1).^E1).^(-2).*(log( ...
       exp(1).^E1)+(-1).*log(exp(1).^E3)).^(-2).*log(exp(1).^E3).^(-2).*( ...
       ((-1)+(exp(1).^E1).^NM).*log(exp(1).^E3).^2+(-1).*log(exp(1).^E1) ...
       .*log(exp(1).^E3).*((-2)+2.*(exp(1).^E1).^NM+(exp(1).^E1).^NM.* ...
       NM.*log(exp(1).^E3))+log(exp(1).^E1).^2.*((-1)+(exp(1).^E3).^NM+( ...
       exp(1).^E1).^NM.*NM.*log(exp(1).^E3)));
    elseif abs(E1-E3)<MIN
       valeq=(1+(-1).*(exp(1).^E1).^((-1).*NM)).*log(exp(1).^E1).^(-3).*(log( ...
       exp(1).^E1)+(-1).*log(exp(1).^E12)).^(-2).*log(exp(1).^E12).^(-1) ...
       .*(((-1)+(exp(1).^E1).^NM).*log(exp(1).^E12).^2+(-1).*log(exp(1) ...
       .^E1).*log(exp(1).^E12).*((-2)+2.*(exp(1).^E1).^NM+(exp(1).^E1) ...
       .^NM.*NM.*log(exp(1).^E12))+log(exp(1).^E1).^2.*((-1)+(exp(1) ...
       .^E12).^NM+(exp(1).^E1).^NM.*NM.*log(exp(1).^E12)));
    elseif abs(E12-E3)<MIN
       valeq=(1+(-1).*(exp(1).^E12).^((-1).*NM)).*log(exp(1).^E1).^(-1).*(log( ...
       exp(1).^E1)+(-1).*log(exp(1).^E12)).^(-2).*log(exp(1).^E12).^(-3) ...
       .*(((-1)+(exp(1).^E1).^NM).*log(exp(1).^E12).^2+log(exp(1).^E1) ...
       .^2.*((-1)+(exp(1).^E12).^NM+(-1).*(exp(1).^E12).^NM.*NM.*log(exp( ...
       1).^E12))+log(exp(1).^E1).*log(exp(1).^E12).*(2+(-2).*(exp(1) ...
       .^E12).^NM+(exp(1).^E12).^NM.*NM.*log(exp(1).^E12)));
    else
       valeq=(1+(-1).*(exp(1).^E3).^((-1).*NM)).*log(exp(1).^E1).^(-1).*(log( ...
       exp(1).^E1)+(-1).*log(exp(1).^E12)).^(-1).*log(exp(1).^E12).^(-1) ...
       .*(log(exp(1).^E1)+(-1).*log(exp(1).^E3)).^(-1).*(log(exp(1).^E12) ...
       +(-1).*log(exp(1).^E3)).^(-1).*log(exp(1).^E3).^(-2).*(((-1)+(exp( ...
       1).^E1).^NM).*log(exp(1).^E12).*(log(exp(1).^E12)+(-1).*log(exp(1) ...
       .^E3)).*log(exp(1).^E3)+log(exp(1).^E1).^2.*(((-1)+(exp(1).^E3) ...
       .^NM).*log(exp(1).^E12)+(-1).*((-1)+(exp(1).^E12).^NM).*log(exp(1) ...
       .^E3))+log(exp(1).^E1).*((-1).*((-1)+(exp(1).^E3).^NM).*log(exp(1) ...
       .^E12).^2+((-1)+(exp(1).^E12).^NM).*log(exp(1).^E3).^2));
    end
    
    % on different monomers
    valne1=(-1).*((-1)+ZE3).^(-2).*ZE3.*(1+N.*((-1)+ZE3)+(-1).*ZE3.^N);
    valne2=(-1).*((-1)+ZE3L).^(-2).*ZE3L.*(1+N.*((-1)+ZE3L)+(-1).*ZE3L.^N);
    valeq=finite(valeq);
    valne1=finite(valne1);
    valne2=finite(valne2);
    
    for I1=1:2
        for I2=1:2
            for I3=1:2
                for I4=1:2
                    FV=[F(I1),F(I2),F(I3),F(I4)];
                    DFV=[DF(I1),DF(I2),DF(I3),DF(I4)];
                    S4(I1,I2,I3,I4)=S4(I1,I2,I3,I4)+SDEL(I1,I2,I3,I4)*...
                      valeq*(FV(A3)*FV(A4)*valne1+...
                         FV(A3)*DFV(A3)*DFV(A4)*(1-FV(A3))*valne2);
                end
            end
        end
    end
end

function S4=case5(S4,N,NM,R1,R12,R3,Z1,Z1L,Z12,Z12L,F,DF,SDEL,A1,A2,A3,MIN)
    E1=R1;
    E12=R12;
    E3=R3;            
    ZE1=[Z1,Z1L];
    ZE12=[Z12,Z12L];

    % on same monomer
    if (abs(E1-E12)<MIN && abs(E12-E3)<MIN)
       valeq=(exp(1).^E1).^((-1).*NM).*((-1)+(exp(1).^E1).^NM).*NM.*log(exp(1) ...
       .^E1).^(-3).*(1+(exp(1).^E1).^NM.*((-1)+NM.*log(exp(1).^E1)));
    elseif abs(E1-E12)<MIN
       valeq=(exp(1).^E1).^((-1).*NM).*((-1)+(exp(1).^E1).^NM).*NM.*log(exp(1) ...
       .^E1).^(-1).*(((-1)+(exp(1).^E1).^NM).*log(exp(1).^E1).^(-1)+(1+( ...
       -1).*(exp(1).^E3).^NM).*log(exp(1).^E3).^(-1)).*(log(exp(1).^E1)+( ...
       -1).*log(exp(1).^E3)).^(-1);
    elseif abs(E1-E3)<MIN
       valeq=(exp(1).^E1).^((-1).*NM).*(exp(1).^E12).^((-1).*NM).*((-1)+(exp(1) ...
       .^E1).^NM).*((exp(1).^E1).^NM+(-1).*(exp(1).^E12).^NM).*log(exp(1) ...
       .^E1).^(-1).*(((-1)+(exp(1).^E1).^NM).*log(exp(1).^E1).^(-1)+(1+( ...
       -1).*(exp(1).^E12).^NM).*log(exp(1).^E12).^(-1)).*(log(exp(1).^E1) ...
       +(-1).*log(exp(1).^E12)).^(-2);
    elseif abs(E12-E3)<MIN
       valeq=(exp(1).^E1).^((-1).*NM).*((-1)+(exp(1).^E1).^NM).*((exp(1).^E1) ...
       .^NM+(-1).*(exp(1).^E12).^NM).*log(exp(1).^E1).^(-1).*(log(exp(1) ...
       .^E1)+(-1).*log(exp(1).^E12)).^(-1).*log(exp(1).^E12).^(-2).*((-1) ...
       +(exp(1).^E12).^((-1).*NM)+NM.*log(exp(1).^E12));
    else
       valeq=(exp(1).^E1).^((-1).*NM).*(exp(1).^E12).^((-1).*NM).*((-1)+(exp(1) ...
       .^E1).^NM).*((exp(1).^E1).^NM+(-1).*(exp(1).^E12).^NM).*log(exp(1) ...
       .^E1).^(-1).*(log(exp(1).^E1)+(-1).*log(exp(1).^E12)).^(-1).*((( ...
       -1)+(exp(1).^E12).^NM).*log(exp(1).^E12).^(-1)+(1+(-1).*(exp(1) ...
       .^E3).^NM).*log(exp(1).^E3).^(-1)).*(log(exp(1).^E12)+(-1).*log( ...
       exp(1).^E3)).^(-1);
    end

    % on different monomers
    MIN=5e-3;
    valne=zeros(2,2);
    for I1=1:2
        for I2=1:2
            ZT1=ZE1(I1);
            ZT12=ZE12(I2);
            if abs(ZT1-ZT12)<MIN
                valne(I1,I2)=((-1)+ZT1).^(-3).*ZT1.*(2.*ZT1+(-1).*N.*ZT1+N.*ZT1.^2+(-1).*N.* ...
                  ZT1.^N+(-2).*ZT1.^(1+N)+N.*ZT1.^(1+N));
            else
                valne(I1,I2)=((-1)+ZT1).^(-2).*ZT1.*(ZT1+(-1).*ZT12).^(-1).*((-1)+ZT12).^(-2).* ...
                  ZT12.*((-2).*ZT1+N.*ZT1+ZT1.^2+(-1).*N.*ZT1.^2+ZT1.^N+2.*ZT12+(-1) ...
                  .*N.*ZT12+N.*ZT1.^2.*ZT12+(-2).*ZT1.^N.*ZT12+(-1).*ZT12.^2+N.* ...
                  ZT12.^2+(-1).*N.*ZT1.*ZT12.^2+ZT1.^N.*ZT12.^2+(-1).*ZT12.^N+2.* ...
                  ZT1.*ZT12.^N+(-1).*ZT1.^2.*ZT12.^N);
            end
        end
    end
    valeq=finite(valeq);
    valne=finite(valne);

    for I1=1:2
        for I2=1:2
            for I3=1:2
                for I4=1:2
                    FV=[F(I1),F(I2),F(I3),F(I4)];
                    DFV=[DF(I1),DF(I2),DF(I3),DF(I4)];
                    S4(I1,I2,I3,I4)=S4(I1,I2,I3,I4)+SDEL(I1,I2,I3,I4)*...
                      valeq*(FV(A1)*FV(A2)*FV(A3)*valne(1,1)+...
                          FV(A1)*FV(A2)*DFV(A2)*DFV(A3)*(1-FV(A2))*valne(1,2)+...
                          FV(A1)*DFV(A1)*DFV(A2)*(1-FV(A1))*FV(A3)*valne(2,1)+...
                          FV(A1)*DFV(A1)*DFV(A2)*(1-FV(A1))*DFV(A2)*DFV(A3)*(1-FV(A2))*valne(2,2));
                end
            end
        end
    end
end

function S4=case6(S4,N,NM,R1,R12,R3,Z12,Z12L,Z3,Z3L,F,DF,SDEL,A2,A3,A4,MIN)
    E1=R1;
    E12=R12;
    E3=R3;            
    ZE12=[Z12,Z12L];
    ZE3=[Z3,Z3L];

    % on same monomer
    if (abs(E1-E12)<MIN && abs(E12-E3)<MIN)
       valeq=(exp(1).^E1).^((-1).*NM).*((-1)+(exp(1).^E1).^NM).*NM.*log(exp(1) ...
       .^E1).^(-3).*(1+(exp(1).^E1).^NM.*((-1)+NM.*log(exp(1).^E1)));
    elseif abs(E1-E12)<MIN
       valeq=(exp(1).^E1).^((-1).*NM).*(1+(-1).*(exp(1).^E3).^((-1).*NM)).*(( ...
       exp(1).^E1).^NM+(-1).*(exp(1).^E3).^NM).*log(exp(1).^E1).^(-2).*( ...
       1+(exp(1).^E1).^NM.*((-1)+NM.*log(exp(1).^E1))).*(log(exp(1).^E1)+ ...
       (-1).*log(exp(1).^E3)).^(-1).*log(exp(1).^E3).^(-1);
    elseif abs(E1-E3)<MIN
       valeq=(exp(1).^E12).^((-1).*NM).*(1+(-1).*(exp(1).^E1).^((-1).*NM)).*(( ...
       exp(1).^E1).^NM+(-1).*(exp(1).^E12).^NM).*log(exp(1).^E1).^(-2).*( ...
       log(exp(1).^E1)+(-1).*log(exp(1).^E12)).^(-2).*log(exp(1).^E12).^( ...
       -1).*((-1).*((-1)+(exp(1).^E12).^NM).*log(exp(1).^E1)+((-1)+(exp( ...
       1).^E1).^NM).*log(exp(1).^E12));
    elseif abs(E12-E3)<MIN
       valeq=(1+(-1).*(exp(1).^E12).^((-1).*NM)).*NM.*log(exp(1).^E1).^(-1).*( ...
       log(exp(1).^E1)+(-1).*log(exp(1).^E12)).^(-1).*log(exp(1).^E12).^( ...
       -2).*((-1).*((-1)+(exp(1).^E12).^NM).*log(exp(1).^E1)+((-1)+(exp( ...
       1).^E1).^NM).*log(exp(1).^E12));
    else
       valeq=(-1).*(exp(1).^E12).^((-1).*NM).*(1+(-1).*(exp(1).^E3).^((-1).*NM) ...
       ).*((exp(1).^E12).^NM+(-1).*(exp(1).^E3).^NM).*log(exp(1).^E1).^( ...
       -1).*(log(exp(1).^E1)+(-1).*log(exp(1).^E12)).^(-1).*log(exp(1) ...
       .^E12).^(-1).*(((-1)+(exp(1).^E12).^NM).*log(exp(1).^E1)+(-1).*(( ...
       -1)+(exp(1).^E1).^NM).*log(exp(1).^E12)).*(log(exp(1).^E12)+(-1).* ...
       log(exp(1).^E3)).^(-1).*log(exp(1).^E3).^(-1);
    end
    
    % on different monomers
    MIN=5e-3;
    valne=zeros(2,2);
    for I1=1:2
        for I2=1:2
            ZT12=ZE12(I1);
            ZT3=ZE3(I2);
            if abs(ZT12-ZT3)<MIN
                valne(I1,I2)=((-1)+ZT12).^(-3).*ZT12.*(2.*ZT12+(-1).*N.*ZT12+N.*ZT12.^2+(-1).* ...
                  N.*ZT12.^N+(-2).*ZT12.^(1+N)+N.*ZT12.^(1+N));
            else
                valne(I1,I2)=((-1)+ZT12).^(-2).*ZT12.*(ZT12+(-1).*ZT3).^(-1).*((-1)+ZT3).^(-2) ...
                  .*ZT3.*((-2).*ZT12+N.*ZT12+ZT12.^2+(-1).*N.*ZT12.^2+ZT12.^N+2.* ...
                  ZT3+(-1).*N.*ZT3+N.*ZT12.^2.*ZT3+(-2).*ZT12.^N.*ZT3+(-1).*ZT3.^2+ ...
                  N.*ZT3.^2+(-1).*N.*ZT12.*ZT3.^2+ZT12.^N.*ZT3.^2+(-1).*ZT3.^N+2.* ...
                  ZT12.*ZT3.^N+(-1).*ZT12.^2.*ZT3.^N);
            end
        end
    end
    valeq=finite(valeq);
    valne=finite(valne);

    for I1=1:2
        for I2=1:2
            for I3=1:2
                for I4=1:2
                    FV=[F(I1),F(I2),F(I3),F(I4)];
                    DFV=[DF(I1),DF(I2),DF(I3),DF(I4)];
                    
                    S4(I1,I2,I3,I4)=S4(I1,I2,I3,I4)+SDEL(I1,I2,I3,I4)*...
                      valeq*(FV(A2)*FV(A3)*FV(A4)*valne(1,1)+...
                          FV(A2)*FV(A3)*DFV(A3)*DFV(A4)*(1-FV(A3))*valne(1,2)+...
                          FV(A2)*DFV(A2)*DFV(A3)*(1-FV(A2))*FV(A4)*valne(2,1)+...
                          FV(A2)*DFV(A2)*DFV(A3)*(1-FV(A2))*DFV(A3)*DFV(A4)*(1-FV(A3))*valne(2,2));
                end
            end
        end
    end
end

function S4=case7(S4,N,NM,R1,R12,R3,Z1,Z1L,Z3,Z3L,F,DF,SDEL,A1,A2,A4,MIN)
    E1=R1;
    E12=R12;
    E3=R3;            
    ZE1=[Z1,Z1L];
    ZE3=[Z3,Z3L];

    % on same monomer
    if (abs(E1-E12)<MIN && abs(E12-E3)<MIN)
       valeq=(1/2).*(exp(1).^E1).^((-1).*NM).*((-1)+(exp(1).^E1).^NM).^2.* ...
       NM.^2.*log(exp(1).^E1).^(-2);
    elseif abs(E1-E12)<MIN
       valeq=(exp(1).^E1).^((-1).*NM).*((-1)+(exp(1).^E1).^NM).*(1+(-1).*(exp( ...
       1).^E3).^((-1).*NM)).*log(exp(1).^E1).^(-1).*(log(exp(1).^E1)+(-1) ...
       .*log(exp(1).^E3)).^(-2).*log(exp(1).^E3).^(-1).*((exp(1).^E3) ...
       .^NM+(exp(1).^E1).^NM.*((-1)+NM.*log(exp(1).^E1)+(-1).*NM.*log( ...
       exp(1).^E3)));
    elseif abs(E1-E3)<MIN
       valeq=(exp(1).^E1).^((-2).*NM).*((-1)+(exp(1).^E1).^NM).^2.*log(exp(1) ...
       .^E1).^(-2).*(log(exp(1).^E1)+(-1).*log(exp(1).^E12)).^(-2).*(( ...
       exp(1).^E12).^NM+(exp(1).^E1).^NM.*((-1)+NM.*log(exp(1).^E1)+(-1) ...
       .*NM.*log(exp(1).^E12)));
    elseif abs(E12-E3)<MIN
       valeq=(exp(1).^E1).^((-1).*NM).*((-1)+(exp(1).^E1).^NM).*(1+(-1).*(exp( ...
       1).^E12).^((-1).*NM)).*log(exp(1).^E1).^(-1).*(log(exp(1).^E1)+( ...
       -1).*log(exp(1).^E12)).^(-2).*log(exp(1).^E12).^(-1).*((exp(1) ...
       .^E1).^NM+(-1).*(exp(1).^E12).^NM+(-1).*(exp(1).^E12).^NM.*NM.* ...
       log(exp(1).^E1)+(exp(1).^E12).^NM.*NM.*log(exp(1).^E12));
    else
       valeq=(exp(1).^E1).^((-1).*NM).*((-1)+(exp(1).^E1).^NM).*(1+(-1).*(exp( ...
       1).^E3).^((-1).*NM)).*log(exp(1).^E1).^(-1).*(log(exp(1).^E1)+(-1) ...
       .*log(exp(1).^E12)).^(-1).*(log(exp(1).^E1)+(-1).*log(exp(1).^E3)) ...
       .^(-1).*log(exp(1).^E3).^(-1).*((-1).*log(exp(1).^E12)+log(exp(1) ...
       .^E3)).^(-1).*(((exp(1).^E12).^NM+(-1).*(exp(1).^E3).^NM).*log( ...
       exp(1).^E1)+((-1).*(exp(1).^E1).^NM+(exp(1).^E3).^NM).*log(exp(1) ...
       .^E12)+((exp(1).^E1).^NM+(-1).*(exp(1).^E12).^NM).*log(exp(1).^E3) ...
       );
    end
    
    % on different monomers
    MIN=5e-3;
    valne=zeros(2,2);
    for I1=1:2
        for I2=1:2
            ZT1=ZE1(I1);
            ZT3=ZE3(I2);
            if abs(ZT1-ZT3)<MIN
                valne(I1,I2)=((-1)+ZT1).^(-3).*ZT1.*(2.*ZT1+(-1).*N.*ZT1+N.*ZT1.^2+(-1).*N.* ...
                  ZT1.^N+(-2).*ZT1.^(1+N)+N.*ZT1.^(1+N));
            else
                valne(I1,I2)=((-1)+ZT1).^(-2).*ZT1.*(ZT1+(-1).*ZT3).^(-1).*((-1)+ZT3).^(-2).* ...
                  ZT3.*((-2).*ZT1+N.*ZT1+ZT1.^2+(-1).*N.*ZT1.^2+ZT1.^N+2.*ZT3+(-1).* ...
                  N.*ZT3+N.*ZT1.^2.*ZT3+(-2).*ZT1.^N.*ZT3+(-1).*ZT3.^2+N.*ZT3.^2+( ...
                  -1).*N.*ZT1.*ZT3.^2+ZT1.^N.*ZT3.^2+(-1).*ZT3.^N+2.*ZT1.*ZT3.^N+( ...
                  -1).*ZT1.^2.*ZT3.^N);
            end
        end
    end
    valeq=finite(valeq);
    valne=finite(valne);

    for I1=1:2
        for I2=1:2
            for I3=1:2
                for I4=1:2
                    FV=[F(I1),F(I2),F(I3),F(I4)];
                    DFV=[DF(I1),DF(I2),DF(I3),DF(I4)];
                    
                    S4(I1,I2,I3,I4)=S4(I1,I2,I3,I4)+SDEL(I1,I2,I3,I4)*...
                      valeq*(FV(A1)*FV(A2)*FV(A4)*valne(1,1)+...
                          FV(A1)*FV(A2)*DFV(A2)*DFV(A4)*(1-FV(A2))*valne(1,2)+...
                          FV(A1)*DFV(A1)*DFV(A2)*(1-FV(A1))*FV(A4)*valne(2,1)+...
                          FV(A1)*DFV(A1)*DFV(A2)*(1-FV(A1))*DFV(A2)*DFV(A4)*(1-FV(A2))*valne(2,2));
                end
            end
        end
    end
end

function S4=case8(S4,N,NM,R1,R12,R3,Z1,Z1L,Z12,Z12L,Z3,Z3L,F,DF,SDEL,A1,A2,A3,A4,MIN)
    E1=R1;
    E12=R12;
    E3=R3;
    ZE1=[Z1,Z1L];
    ZE12=[Z12,Z12L];
    ZE3=[Z3,Z3L];
%{ 
    % on same monomer
    if (abs(E1-E12)<MIN && abs(E12-E3)<MIN)
       valeq=2.*E1.^(-2).*NM.^2.*((-1)+cosh(E1.*NM));
    elseif (abs(E1-E12)<MIN && abs(E12-E3)>=MIN)
       valeq=exp(1).^((-1).*(E1+E3).*NM).*((-1)+exp(1).^(E1.*NM)).*(exp(1).^( ...
          E1.*NM)+(-1).*exp(1).^(E3.*NM)).*((-1)+exp(1).^(E3.*NM)).*E1.^(-1) ...
          .*(E1+(-1).*E3).^(-1).*E3.^(-1).*NM;
    elseif (abs(E1-E3)<MIN && abs(E1-E12)>=MIN)
       valeq=16.*E1.^(-2).*(E1+(-1).*E12).^(-2).*sinh((1/2).*E1.*NM).^2.*sinh(( ...
        1/2).*(E1+(-1).*E12).*NM).^2;
    elseif (abs(E12-E3)<MIN && abs(E1-E3)>=MIN)
       valeq=exp(1).^((-1).*(E1+E12).*NM).*((-1)+exp(1).^(E1.*NM)).*(exp(1).^( ...
          E1.*NM)+(-1).*exp(1).^(E12.*NM)).*((-1)+exp(1).^(E12.*NM)).*E1.^( ...
          -1).*(E1+(-1).*E12).^(-1).*E12.^(-1).*NM;
    else
       valeq=exp(1).^((-1).*(E1+E12+E3).*NM).*((-1)+exp(1).^(E1.*NM)).*(exp(1) ...
          .^(E1.*NM)+(-1).*exp(1).^(E12.*NM)).*(exp(1).^(E12.*NM)+(-1).*exp( ...
          1).^(E3.*NM)).*((-1)+exp(1).^(E3.*NM)).*E1.^(-1).*(E1+(-1).*E12) ...
          .^(-1).*(E12+(-1).*E3).^(-1).*E3.^(-1);
    end
%}    
   valeq=2*( -coshl(4,NM*E1)+coshl(4,NM*E12)-coshl(4,NM*E3)-coshl(4,NM*(E1-E12))+...
       coshl(4,NM*(E1-E3))-coshl(4,NM*(E12-E3))+coshl(4,NM*(-E1+E12-E3)) )...
       *( (E12-E3)*E3*E1*(E12-E1) )^(-1);    
    
    % on different monomers
%    MIN=4e-3;
%     MIN=abs(exp(NM)*exp(R1)*(1-exp(MIN)));
%     MIN=1e-3;
    valne=zeros(2,2,2);
    for I1=1:2
        for I2=1:2
            for I3=1:2
                ZT1=ZE1(I1);
                ZT12=ZE12(I2);
                ZT3=ZE3(I3);
%{
                % subcase 1
                if (abs(ZT1-1)<MIN && abs(ZT12-1)<MIN && abs(ZT3-1)<MIN)
                        valne(I1,I2,I3)=(1/24).*((-6).*N+11.*N.^2+(-6).*N.^3+N.^4);
                % subcase 2
                elseif (abs(ZT1-1)<MIN && abs(ZT12-1)<MIN && abs(ZT3-1)>=MIN)
                    valne(I1,I2,I3)=(-1/6).*((-1)+ZT3).^(-4).*ZT3.*(6+(-11).*N+6.*N.^2+(-1).*N.^3+18.* ...
                           N.*ZT3+(-15).*N.^2.*ZT3+3.*N.^3.*ZT3+(-9).*N.*ZT3.^2+12.*N.^2.* ...
                           ZT3.^2+(-3).*N.^3.*ZT3.^2+2.*N.*ZT3.^3+(-3).*N.^2.*ZT3.^3+N.^3.* ...
                           ZT3.^3+(-6).*ZT3.^N);
                % subcase 3
                elseif (abs(ZT1-1)>=MIN && abs(ZT12-1)<MIN && abs(ZT3-1)<MIN)
                    valne(I1,I2,I3)=(-1/6).*((-1)+ZT1).^(-4).*ZT1.*(12.*ZT1+(-4).*N.*ZT1+(-3).*N.^2.* ...
                          ZT1+N.^3.*ZT1+(-6).*ZT1.^2+2.*N.*ZT1.^2+6.*N.^2.*ZT1.^2+(-2).* ...
                         N.^3.*ZT1.^2+2.*N.*ZT1.^3+(-3).*N.^2.*ZT1.^3+N.^3.*ZT1.^3+(-6).* ...
                          ZT1.^N);
                % subcase 4
                elseif (abs(ZT1-1)<MIN && abs(ZT12-1)>=MIN && abs(ZT3-1)<MIN)
                    valne(I1,I2,I3)=(-1/6).*((-1)+ZT12).^(-4).*ZT12.*(6+(-11).*N+6.*N.^2+(-1).*N.^3+ ...
                   18.*N.*ZT12+(-15).*N.^2.*ZT12+3.*N.^3.*ZT12+(-9).*N.*ZT12.^2+12.* ...
                   N.^2.*ZT12.^2+(-3).*N.^3.*ZT12.^2+2.*N.*ZT12.^3+(-3).*N.^2.* ...
                   ZT12.^3+N.^3.*ZT12.^3+(-6).*ZT12.^N);
                % subcase 5
                elseif (abs(ZT1-1)<MIN && abs(ZT12-1)>=MIN && abs(ZT3-1)>=MIN)

                    if (abs(ZT12-ZT3)<MIN)
                        valne(I1,I2,I3)=(1/2).*((-1)+ZT12).^(-4).*ZT12.*(6.*ZT12+(-5).*N.*ZT12+N.^2.*ZT12+ ...
                          6.*N.*ZT12.^2+(-2).*N.^2.*ZT12.^2+(-1).*N.*ZT12.^3+N.^2.*ZT12.^3+( ...
                          -2).*N.*ZT12.^N+(-6).*ZT12.^(1+N)+2.*N.*ZT12.^(1+N));
                    else
                        valne(I1,I2,I3)=(1/2).*((-1)+ZT12).^(-3).*(ZT12+(-1).*ZT3).^(-1).*((-1)+ZT3).^(-3) ...
                          .*(6.*ZT12.^2.*ZT3+(-5).*N.*ZT12.^2.*ZT3+N.^2.*ZT12.^2.*ZT3+(-6).* ...
                          ZT12.^3.*ZT3+8.*N.*ZT12.^3.*ZT3+(-2).*N.^2.*ZT12.^3.*ZT3+2.* ...
                          ZT12.^4.*ZT3+(-3).*N.*ZT12.^4.*ZT3+N.^2.*ZT12.^4.*ZT3+(-2).* ...
                          ZT12.^(1+N).*ZT3+(-6).*ZT12.*ZT3.^2+5.*N.*ZT12.*ZT3.^2+(-1).* ...
                          N.^2.*ZT12.*ZT3.^2+(-9).*N.*ZT12.^3.*ZT3.^2+3.*N.^2.*ZT12.^3.* ...
                          ZT3.^2+4.*N.*ZT12.^4.*ZT3.^2+(-2).*N.^2.*ZT12.^4.*ZT3.^2+6.* ...
                          ZT12.^(1+N).*ZT3.^2+6.*ZT12.*ZT3.^3+(-8).*N.*ZT12.*ZT3.^3+2.* ...
                          N.^2.*ZT12.*ZT3.^3+9.*N.*ZT12.^2.*ZT3.^3+(-3).*N.^2.*ZT12.^2.* ...
                          ZT3.^3+(-1).*N.*ZT12.^4.*ZT3.^3+N.^2.*ZT12.^4.*ZT3.^3+(-6).* ...
                          ZT12.^(1+N).*ZT3.^3+(-2).*ZT12.*ZT3.^4+3.*N.*ZT12.*ZT3.^4+(-1).* ...
                          N.^2.*ZT12.*ZT3.^4+(-4).*N.*ZT12.^2.*ZT3.^4+2.*N.^2.*ZT12.^2.* ...
                          ZT3.^4+N.*ZT12.^3.*ZT3.^4+(-1).*N.^2.*ZT12.^3.*ZT3.^4+2.*ZT12.^(1+ ...
                          N).*ZT3.^4+2.*ZT12.*ZT3.^(1+N)+(-6).*ZT12.^2.*ZT3.^(1+N)+6.* ...
                          ZT12.^3.*ZT3.^(1+N)+(-2).*ZT12.^4.*ZT3.^(1+N));
                    end
                % subcase 6
                elseif (abs(ZT1-1)>=MIN && abs(ZT12-1)<MIN && abs(ZT3-1)>=MIN)
                    
                    if (abs(ZT1-ZT3)<MIN)
                        valne(I1,I2,I3)=(1/2).*((-1)+ZT1).^(-4).*ZT1.*(6.*ZT1+(-5).*N.*ZT1+N.^2.*ZT1+6.* ...
                          N.*ZT1.^2+(-2).*N.^2.*ZT1.^2+(-1).*N.*ZT1.^3+N.^2.*ZT1.^3+(-2).* ...
                          N.*ZT1.^N+(-6).*ZT1.^(1+N)+2.*N.*ZT1.^(1+N));
                    else
                        valne(I1,I2,I3)=(1/2).*((-1)+ZT1).^(-3).*(ZT1+(-1).*ZT3).^(-1).*((-1)+ZT3).^(-3).* ...
                          (6.*ZT1.^2.*ZT3+(-5).*N.*ZT1.^2.*ZT3+N.^2.*ZT1.^2.*ZT3+(-6).* ...
                          ZT1.^3.*ZT3+8.*N.*ZT1.^3.*ZT3+(-2).*N.^2.*ZT1.^3.*ZT3+2.*ZT1.^4.* ...
                          ZT3+(-3).*N.*ZT1.^4.*ZT3+N.^2.*ZT1.^4.*ZT3+(-2).*ZT1.^(1+N).*ZT3+( ...
                          -6).*ZT1.*ZT3.^2+5.*N.*ZT1.*ZT3.^2+(-1).*N.^2.*ZT1.*ZT3.^2+(-9).* ...
                          N.*ZT1.^3.*ZT3.^2+3.*N.^2.*ZT1.^3.*ZT3.^2+4.*N.*ZT1.^4.*ZT3.^2+( ...
                          -2).*N.^2.*ZT1.^4.*ZT3.^2+6.*ZT1.^(1+N).*ZT3.^2+6.*ZT1.*ZT3.^3+( ...
                          -8).*N.*ZT1.*ZT3.^3+2.*N.^2.*ZT1.*ZT3.^3+9.*N.*ZT1.^2.*ZT3.^3+(-3) ...
                          .*N.^2.*ZT1.^2.*ZT3.^3+(-1).*N.*ZT1.^4.*ZT3.^3+N.^2.*ZT1.^4.* ...
                          ZT3.^3+(-6).*ZT1.^(1+N).*ZT3.^3+(-2).*ZT1.*ZT3.^4+3.*N.*ZT1.* ...
                          ZT3.^4+(-1).*N.^2.*ZT1.*ZT3.^4+(-4).*N.*ZT1.^2.*ZT3.^4+2.*N.^2.* ...
                          ZT1.^2.*ZT3.^4+N.*ZT1.^3.*ZT3.^4+(-1).*N.^2.*ZT1.^3.*ZT3.^4+2.* ...
                          ZT1.^(1+N).*ZT3.^4+2.*ZT1.*ZT3.^(1+N)+(-6).*ZT1.^2.*ZT3.^(1+N)+6.* ...
                          ZT1.^3.*ZT3.^(1+N)+(-2).*ZT1.^4.*ZT3.^(1+N));
                    end
                % subcase 7
                elseif (abs(ZT1-1)>=MIN && abs(ZT12-1)>=MIN && abs(ZT3-1)<MIN)
                    
                    if (abs(ZT1-ZT12)<MIN)
                        valne(I1,I2,I3)=(1/2).*((-1)+ZT1).^(-4).*ZT1.*(6.*ZT1+(-5).*N.*ZT1+N.^2.*ZT1+6.* ...
                           N.*ZT1.^2+(-2).*N.^2.*ZT1.^2+(-1).*N.*ZT1.^3+N.^2.*ZT1.^3+(-2).* ...
                           N.*ZT1.^N+(-6).*ZT1.^(1+N)+2.*N.*ZT1.^(1+N));
                    else
                        valne(I1,I2,I3)=(1/2).*((-1)+ZT1).^(-3).*(ZT1+(-1).*ZT12).^(-1).*((-1)+ZT12).^(-3) ...
                          .*(6.*ZT1.^2.*ZT12+(-5).*N.*ZT1.^2.*ZT12+N.^2.*ZT1.^2.*ZT12+(-6).* ...
                          ZT1.^3.*ZT12+8.*N.*ZT1.^3.*ZT12+(-2).*N.^2.*ZT1.^3.*ZT12+2.* ...
                          ZT1.^4.*ZT12+(-3).*N.*ZT1.^4.*ZT12+N.^2.*ZT1.^4.*ZT12+(-2).*ZT1.^( ...
                          1+N).*ZT12+(-6).*ZT1.*ZT12.^2+5.*N.*ZT1.*ZT12.^2+(-1).*N.^2.*ZT1.* ...
                          ZT12.^2+(-9).*N.*ZT1.^3.*ZT12.^2+3.*N.^2.*ZT1.^3.*ZT12.^2+4.*N.* ...
                          ZT1.^4.*ZT12.^2+(-2).*N.^2.*ZT1.^4.*ZT12.^2+6.*ZT1.^(1+N).* ...
                          ZT12.^2+6.*ZT1.*ZT12.^3+(-8).*N.*ZT1.*ZT12.^3+2.*N.^2.*ZT1.* ...
                          ZT12.^3+9.*N.*ZT1.^2.*ZT12.^3+(-3).*N.^2.*ZT1.^2.*ZT12.^3+(-1).* ...
                          N.*ZT1.^4.*ZT12.^3+N.^2.*ZT1.^4.*ZT12.^3+(-6).*ZT1.^(1+N).* ...
                          ZT12.^3+(-2).*ZT1.*ZT12.^4+3.*N.*ZT1.*ZT12.^4+(-1).*N.^2.*ZT1.* ...
                          ZT12.^4+(-4).*N.*ZT1.^2.*ZT12.^4+2.*N.^2.*ZT1.^2.*ZT12.^4+N.* ...
                          ZT1.^3.*ZT12.^4+(-1).*N.^2.*ZT1.^3.*ZT12.^4+2.*ZT1.^(1+N).* ...
                          ZT12.^4+2.*ZT1.*ZT12.^(1+N)+(-6).*ZT1.^2.*ZT12.^(1+N)+6.*ZT1.^3.* ...
                          ZT12.^(1+N)+(-2).*ZT1.^4.*ZT12.^(1+N));
                    end
                %subcase 8
                else                    
                    sMIN=MIN;
                    MIN=1e-12;
                    if (abs(ZT1-ZT12)<MIN && abs(ZT12-ZT3)<MIN)
                        valne(I1,I2,I3)=(1/2).*((-1)+ZT1).^(-4).*(2.*ZT1.^3.*((-3)+N+(-1).*N.*ZT1)+ZT1.^( ...
                      1+N).*(((-1)+N).*N+(-2).*((-3)+N).*N.*ZT1+((-3)+N).*((-2)+N).* ...
                     ZT1.^2));
                    elseif (abs(ZT1-ZT12)<MIN && abs(ZT1-ZT3)>=MIN)
                        valne(I1,I2,I3)=((-1)+ZT1).^(-3).*(ZT1+(-1).*ZT3).^(-2).*((-1)+ZT3).^(-2).*(3.* ...
                       ZT1.^4.*ZT3+(-1).*N.*ZT1.^4.*ZT3+(-1).*ZT1.^5.*ZT3+N.*ZT1.^5.*ZT3+ ...
                       ZT1.^(2+N).*ZT3+(-1).*N.*ZT1.^(2+N).*ZT3+(-3).*ZT1.^(3+N).*ZT3+N.* ...
                       ZT1.^(3+N).*ZT3+(-6).*ZT1.^3.*ZT3.^2+2.*N.*ZT1.^3.*ZT3.^2+(-1).* ...
                       N.*ZT1.^4.*ZT3.^2+(-1).*N.*ZT1.^5.*ZT3.^2+N.*ZT1.^(1+N).*ZT3.^2+ ...
                       N.*ZT1.^(2+N).*ZT3.^2+6.*ZT1.^(3+N).*ZT3.^2+(-2).*N.*ZT1.^(3+N).* ...
                       ZT3.^2+3.*ZT1.^2.*ZT3.^3+(-1).*N.*ZT1.^2.*ZT3.^3+3.*ZT1.^3.* ...
                       ZT3.^3+(-1).*N.*ZT1.^3.*ZT3.^3+2.*N.*ZT1.^4.*ZT3.^3+(-2).*N.* ...
                       ZT1.^(1+N).*ZT3.^3+(-3).*ZT1.^(2+N).*ZT3.^3+N.*ZT1.^(2+N).*ZT3.^3+ ...
                       (-3).*ZT1.^(3+N).*ZT3.^3+N.*ZT1.^(3+N).*ZT3.^3+(-2).*ZT1.^2.* ...
                       ZT3.^4+N.*ZT1.^2.*ZT3.^4+(-1).*N.*ZT1.^3.*ZT3.^4+N.*ZT1.^(1+N).* ...
                       ZT3.^4+2.*ZT1.^(2+N).*ZT3.^4+(-1).*N.*ZT1.^(2+N).*ZT3.^4+(-1).* ...
                       ZT1.^2.*ZT3.^(1+N)+3.*ZT1.^3.*ZT3.^(1+N)+(-3).*ZT1.^4.*ZT3.^(1+N)+ ...
                       ZT1.^5.*ZT3.^(1+N));
                    elseif (abs(ZT1-ZT3)<MIN && abs(ZT1-ZT12)>=MIN)
                        valne(I1,I2,I3)=((-1)+ZT1).^(-3).*(ZT1+(-1).*ZT12).^(-1).*((-1)+ZT12).^(-2).*((-1) ...
                      .*ZT1+ZT12).^(-1).*((-3).*ZT1.^4.*ZT12+N.*ZT1.^4.*ZT12+ZT1.^5.* ...
                      ZT12+(-1).*N.*ZT1.^5.*ZT12+(-1).*ZT1.^(2+N).*ZT12+N.*ZT1.^(2+N).* ...
                      ZT12+3.*ZT1.^(3+N).*ZT12+(-1).*N.*ZT1.^(3+N).*ZT12+6.*ZT1.^3.* ...
                      ZT12.^2+(-2).*N.*ZT1.^3.*ZT12.^2+N.*ZT1.^4.*ZT12.^2+N.*ZT1.^5.* ...
                      ZT12.^2+(-1).*N.*ZT1.^(1+N).*ZT12.^2+(-1).*N.*ZT1.^(2+N).*ZT12.^2+ ...
                      (-6).*ZT1.^(3+N).*ZT12.^2+2.*N.*ZT1.^(3+N).*ZT12.^2+(-3).*ZT1.^2.* ...
                      ZT12.^3+N.*ZT1.^2.*ZT12.^3+(-3).*ZT1.^3.*ZT12.^3+N.*ZT1.^3.* ...
                      ZT12.^3+(-2).*N.*ZT1.^4.*ZT12.^3+2.*N.*ZT1.^(1+N).*ZT12.^3+3.* ...
                      ZT1.^(2+N).*ZT12.^3+(-1).*N.*ZT1.^(2+N).*ZT12.^3+3.*ZT1.^(3+N).* ...
                      ZT12.^3+(-1).*N.*ZT1.^(3+N).*ZT12.^3+2.*ZT1.^2.*ZT12.^4+(-1).*N.* ...
                      ZT1.^2.*ZT12.^4+N.*ZT1.^3.*ZT12.^4+(-1).*N.*ZT1.^(1+N).*ZT12.^4+( ...
                      -2).*ZT1.^(2+N).*ZT12.^4+N.*ZT1.^(2+N).*ZT12.^4+ZT1.^2.*ZT12.^(1+ ...
                      N)+(-3).*ZT1.^3.*ZT12.^(1+N)+3.*ZT1.^4.*ZT12.^(1+N)+(-1).*ZT1.^5.* ...
                      ZT12.^(1+N));
                    elseif (abs(ZT12-ZT3)<MIN &&  abs(ZT1-ZT3)>=MIN)
                        valne(I1,I2,I3)=(-1).*((-1)+ZT1).^(-2).*(ZT1+(-1).*ZT12).^(-2).*((-1)+ZT12).^(-3) ...
                      .*((-3).*ZT1.^3.*ZT12.^2+N.*ZT1.^3.*ZT12.^2+2.*ZT1.^4.*ZT12.^2+( ...
                      -1).*N.*ZT1.^4.*ZT12.^2+ZT1.^(1+N).*ZT12.^2+6.*ZT1.^2.*ZT12.^3+( ...
                      -2).*N.*ZT1.^2.*ZT12.^3+(-3).*ZT1.^3.*ZT12.^3+N.*ZT1.^3.*ZT12.^3+ ...
                      N.*ZT1.^4.*ZT12.^3+(-3).*ZT1.^(1+N).*ZT12.^3+(-3).*ZT1.*ZT12.^4+ ...
                      N.*ZT1.*ZT12.^4+N.*ZT1.^2.*ZT12.^4+(-2).*N.*ZT1.^3.*ZT12.^4+3.* ...
                      ZT1.^(1+N).*ZT12.^4+ZT1.*ZT12.^5+(-1).*N.*ZT1.*ZT12.^5+N.*ZT1.^2.* ...
                      ZT12.^5+(-1).*ZT1.^(1+N).*ZT12.^5+(-1).*N.*ZT1.^2.*ZT12.^(1+N)+2.* ...
                      N.*ZT1.^3.*ZT12.^(1+N)+(-1).*N.*ZT1.^4.*ZT12.^(1+N)+(-1).*ZT1.* ...
                      ZT12.^(2+N)+N.*ZT1.*ZT12.^(2+N)+(-1).*N.*ZT1.^2.*ZT12.^(2+N)+3.* ...
                      ZT1.^3.*ZT12.^(2+N)+(-1).*N.*ZT1.^3.*ZT12.^(2+N)+(-2).*ZT1.^4.* ...
                      ZT12.^(2+N)+N.*ZT1.^4.*ZT12.^(2+N)+3.*ZT1.*ZT12.^(3+N)+(-1).*N.* ...
                      ZT1.*ZT12.^(3+N)+(-6).*ZT1.^2.*ZT12.^(3+N)+2.*N.*ZT1.^2.*ZT12.^(3+ ...
                      N)+3.*ZT1.^3.*ZT12.^(3+N)+(-1).*N.*ZT1.^3.*ZT12.^(3+N));
                    else 
                        if (min([ZT1,ZT12,ZT3])>0)
                            valne(I1,I2,I3)=case8subcase8(ZT1,ZT12,ZT3,N);
                        else
                            if max([ZT1,ZT12,ZT3])>0.98
                                error('near one')
                            end
                            valne(I1,I2,I3)=((-1)+ZT1).^(-2).*(ZT1+(-1).*ZT12).^(-1).*((-1)+ZT12).^(-2).*(ZT1+ ...
                           (-1).*ZT3).^(-1).*((-1)+ZT3).^(-2).*((-1).*ZT12+ZT3).^(-1).*(3.* ...
                           ZT1.^3.*ZT12.^2.*ZT3+(-1).*N.*ZT1.^3.*ZT12.^2.*ZT3+(-2).*ZT1.^4.* ...
                           ZT12.^2.*ZT3+N.*ZT1.^4.*ZT12.^2.*ZT3+(-1).*ZT1.^(1+N).*ZT12.^2.* ...
                           ZT3+(-3).*ZT1.^2.*ZT12.^3.*ZT3+N.*ZT1.^2.*ZT12.^3.*ZT3+ZT1.^4.* ...
                           ZT12.^3.*ZT3+(-1).*N.*ZT1.^4.*ZT12.^3.*ZT3+2.*ZT1.^(1+N).* ...
                           ZT12.^3.*ZT3+2.*ZT1.^2.*ZT12.^4.*ZT3+(-1).*N.*ZT1.^2.*ZT12.^4.* ...
                           ZT3+(-1).*ZT1.^3.*ZT12.^4.*ZT3+N.*ZT1.^3.*ZT12.^4.*ZT3+(-1).* ...
                           ZT1.^(1+N).*ZT12.^4.*ZT3+ZT1.^2.*ZT12.^(1+N).*ZT3+(-2).*ZT1.^3.* ...
                           ZT12.^(1+N).*ZT3+ZT1.^4.*ZT12.^(1+N).*ZT3+(-3).*ZT1.^3.*ZT12.* ...
                           ZT3.^2+N.*ZT1.^3.*ZT12.*ZT3.^2+2.*ZT1.^4.*ZT12.*ZT3.^2+(-1).*N.* ...
                           ZT1.^4.*ZT12.*ZT3.^2+ZT1.^(1+N).*ZT12.*ZT3.^2+3.*ZT1.*ZT12.^3.* ...
                           ZT3.^2+(-1).*N.*ZT1.*ZT12.^3.*ZT3.^2+N.*ZT1.^4.*ZT12.^3.*ZT3.^2+( ...
                           -3).*ZT1.^(1+N).*ZT12.^3.*ZT3.^2+(-2).*ZT1.*ZT12.^4.*ZT3.^2+N.* ...
                           ZT1.*ZT12.^4.*ZT3.^2+(-1).*N.*ZT1.^3.*ZT12.^4.*ZT3.^2+2.*ZT1.^(1+ ...
                           N).*ZT12.^4.*ZT3.^2+(-1).*ZT1.*ZT12.^(1+N).*ZT3.^2+3.*ZT1.^3.* ...
                           ZT12.^(1+N).*ZT3.^2+(-2).*ZT1.^4.*ZT12.^(1+N).*ZT3.^2+3.*ZT1.^2.* ...
                           ZT12.*ZT3.^3+(-1).*N.*ZT1.^2.*ZT12.*ZT3.^3+(-1).*ZT1.^4.*ZT12.* ...
                           ZT3.^3+N.*ZT1.^4.*ZT12.*ZT3.^3+(-2).*ZT1.^(1+N).*ZT12.*ZT3.^3+(-3) ...
                           .*ZT1.*ZT12.^2.*ZT3.^3+N.*ZT1.*ZT12.^2.*ZT3.^3+(-1).*N.*ZT1.^4.* ...
                           ZT12.^2.*ZT3.^3+3.*ZT1.^(1+N).*ZT12.^2.*ZT3.^3+ZT1.*ZT12.^4.* ...
                           ZT3.^3+(-1).*N.*ZT1.*ZT12.^4.*ZT3.^3+N.*ZT1.^2.*ZT12.^4.*ZT3.^3+( ...
                           -1).*ZT1.^(1+N).*ZT12.^4.*ZT3.^3+2.*ZT1.*ZT12.^(1+N).*ZT3.^3+(-3) ...
                           .*ZT1.^2.*ZT12.^(1+N).*ZT3.^3+ZT1.^4.*ZT12.^(1+N).*ZT3.^3+(-2).* ...
                           ZT1.^2.*ZT12.*ZT3.^4+N.*ZT1.^2.*ZT12.*ZT3.^4+ZT1.^3.*ZT12.*ZT3.^4+ ...
                           (-1).*N.*ZT1.^3.*ZT12.*ZT3.^4+ZT1.^(1+N).*ZT12.*ZT3.^4+2.*ZT1.* ...
                           ZT12.^2.*ZT3.^4+(-1).*N.*ZT1.*ZT12.^2.*ZT3.^4+N.*ZT1.^3.*ZT12.^2.* ...
                           ZT3.^4+(-2).*ZT1.^(1+N).*ZT12.^2.*ZT3.^4+(-1).*ZT1.*ZT12.^3.* ...
                           ZT3.^4+N.*ZT1.*ZT12.^3.*ZT3.^4+(-1).*N.*ZT1.^2.*ZT12.^3.*ZT3.^4+ ...
                           ZT1.^(1+N).*ZT12.^3.*ZT3.^4+(-1).*ZT1.*ZT12.^(1+N).*ZT3.^4+2.* ...
                           ZT1.^2.*ZT12.^(1+N).*ZT3.^4+(-1).*ZT1.^3.*ZT12.^(1+N).*ZT3.^4+(-1) ...
                           .*ZT1.^2.*ZT12.*ZT3.^(1+N)+2.*ZT1.^3.*ZT12.*ZT3.^(1+N)+(-1).* ...
                           ZT1.^4.*ZT12.*ZT3.^(1+N)+ZT1.*ZT12.^2.*ZT3.^(1+N)+(-3).*ZT1.^3.* ...
                           ZT12.^2.*ZT3.^(1+N)+2.*ZT1.^4.*ZT12.^2.*ZT3.^(1+N)+(-2).*ZT1.* ...
                           ZT12.^3.*ZT3.^(1+N)+3.*ZT1.^2.*ZT12.^3.*ZT3.^(1+N)+(-1).*ZT1.^4.* ...
                           ZT12.^3.*ZT3.^(1+N)+ZT1.*ZT12.^4.*ZT3.^(1+N)+(-2).*ZT1.^2.* ...
                           ZT12.^4.*ZT3.^(1+N)+ZT1.^3.*ZT12.^4.*ZT3.^(1+N));
                        end 
                    end
                    MIN=sMIN;
                end
                
%                 if (valne(I1,I2,I3)>1e5)
%                     token
%                 end
%}
                if min([ZT1,ZT12,ZT3])<0
                    error('The following command has a log in it which cannot accept negitive inputs')
                end
                valne(I1,I2,I3)=case8JPart(ZT1,ZT12,ZT3,N);
                
            end
        end
    end
%     valne=ones(2,2,2);
%    valeq=finite(valeq);
%    valne=finite(valne);
    
    for I1=1:2
        for I2=1:2
            for I3=1:2
                for I4=1:2
                    FV=[F(I1),F(I2),F(I3),F(I4)];
                    DFV=[DF(I1),DF(I2),DF(I3),DF(I4)];
                    
                    S4(I1,I2,I3,I4)=S4(I1,I2,I3,I4)+SDEL(I1,I2,I3,I4)*...
                      valeq*(FV(A1)*FV(A2)*FV(A3)*FV(A4)*valne(1,1,1)+...
                           FV(A1)*FV(A2)*FV(A3)*DFV(A3)*DFV(A4)*(1-FV(A3))*valne(1,1,2)+...
                           FV(A1)*FV(A2)*DFV(A2)*DFV(A3)*(1-FV(A2))*FV(A4)*valne(1,2,1)+...
                           FV(A1)*FV(A2)*DFV(A2)*DFV(A3)*(1-FV(A2))*DFV(A3)*DFV(A4)*(1-FV(A3))*valne(1,2,2)+...
                           FV(A1)*DFV(A1)*DFV(A2)*(1-FV(A1))*FV(A3)*FV(A4)*valne(2,1,1)+...
                           FV(A1)*DFV(A1)*DFV(A2)*(1-FV(A1))*FV(A3)*DFV(A3)*DFV(A4)*(1-FV(A3))*valne(2,1,2)+...
                           FV(A1)*DFV(A1)*DFV(A2)*(1-FV(A1))*DFV(A2)*DFV(A3)*(1-FV(A2))*FV(A4)*valne(2,2,1)+...
                           FV(A1)*DFV(A1)*DFV(A2)*(1-FV(A1))*DFV(A2)*DFV(A3)*(1-FV(A2))*DFV(A3)*DFV(A4)*(1-FV(A3))*valne(2,2,2));
                end
            end
        end
    end
end

function out=case8JPart(a,b,c,N)
    x1=log(a);
    x2=log(b);
    x3=log(c);
    if( min([a,b,c])<0)
        error('inputs must be positive')
    end
    if a*b*c==0
        out=0;
        return 
    end
    %[a,b,c]=offset(a,b,c,3.0e-6); %keeps a and b and c different
    
    cut=(0.2*2^(1.5*log10(N)-2));
    cut1=(0.12*2^(1.5*log10(N)-2));
    order=sort([c,b,a]);
    a=order(3);b=order(2);c=order(1); % a > b > c
    
    if 0 %max([a,b,c])<0.5 %I included this for speedup but in rarly gets used 
 %{
       ZT1=a;
        ZT12=b;
        ZT3=c;
        out=((-1)+ZT1).^(-2).*(ZT1+(-1).*ZT12).^(-1).*((-1)+ZT12).^(-2).*(ZT1+ ...
        (-1).*ZT3).^(-1).*((-1)+ZT3).^(-2).*((-1).*ZT12+ZT3).^(-1).*(3.* ...
        ZT1.^3.*ZT12.^2.*ZT3+(-1).*N.*ZT1.^3.*ZT12.^2.*ZT3+(-2).*ZT1.^4.* ...
        ZT12.^2.*ZT3+N.*ZT1.^4.*ZT12.^2.*ZT3+(-1).*ZT1.^(1+N).*ZT12.^2.* ...
        ZT3+(-3).*ZT1.^2.*ZT12.^3.*ZT3+N.*ZT1.^2.*ZT12.^3.*ZT3+ZT1.^4.* ...
        ZT12.^3.*ZT3+(-1).*N.*ZT1.^4.*ZT12.^3.*ZT3+2.*ZT1.^(1+N).* ...
        ZT12.^3.*ZT3+2.*ZT1.^2.*ZT12.^4.*ZT3+(-1).*N.*ZT1.^2.*ZT12.^4.* ...
        ZT3+(-1).*ZT1.^3.*ZT12.^4.*ZT3+N.*ZT1.^3.*ZT12.^4.*ZT3+(-1).* ...
        ZT1.^(1+N).*ZT12.^4.*ZT3+ZT1.^2.*ZT12.^(1+N).*ZT3+(-2).*ZT1.^3.* ...
        ZT12.^(1+N).*ZT3+ZT1.^4.*ZT12.^(1+N).*ZT3+(-3).*ZT1.^3.*ZT12.* ...
        ZT3.^2+N.*ZT1.^3.*ZT12.*ZT3.^2+2.*ZT1.^4.*ZT12.*ZT3.^2+(-1).*N.* ...
        ZT1.^4.*ZT12.*ZT3.^2+ZT1.^(1+N).*ZT12.*ZT3.^2+3.*ZT1.*ZT12.^3.* ...
        ZT3.^2+(-1).*N.*ZT1.*ZT12.^3.*ZT3.^2+N.*ZT1.^4.*ZT12.^3.*ZT3.^2+( ...
        -3).*ZT1.^(1+N).*ZT12.^3.*ZT3.^2+(-2).*ZT1.*ZT12.^4.*ZT3.^2+N.* ...
        ZT1.*ZT12.^4.*ZT3.^2+(-1).*N.*ZT1.^3.*ZT12.^4.*ZT3.^2+2.*ZT1.^(1+ ...
        N).*ZT12.^4.*ZT3.^2+(-1).*ZT1.*ZT12.^(1+N).*ZT3.^2+3.*ZT1.^3.* ...
        ZT12.^(1+N).*ZT3.^2+(-2).*ZT1.^4.*ZT12.^(1+N).*ZT3.^2+3.*ZT1.^2.* ...
        ZT12.*ZT3.^3+(-1).*N.*ZT1.^2.*ZT12.*ZT3.^3+(-1).*ZT1.^4.*ZT12.* ...
        ZT3.^3+N.*ZT1.^4.*ZT12.*ZT3.^3+(-2).*ZT1.^(1+N).*ZT12.*ZT3.^3+(-3) ...
        .*ZT1.*ZT12.^2.*ZT3.^3+N.*ZT1.*ZT12.^2.*ZT3.^3+(-1).*N.*ZT1.^4.* ...
        ZT12.^2.*ZT3.^3+3.*ZT1.^(1+N).*ZT12.^2.*ZT3.^3+ZT1.*ZT12.^4.* ...
        ZT3.^3+(-1).*N.*ZT1.*ZT12.^4.*ZT3.^3+N.*ZT1.^2.*ZT12.^4.*ZT3.^3+( ...
        -1).*ZT1.^(1+N).*ZT12.^4.*ZT3.^3+2.*ZT1.*ZT12.^(1+N).*ZT3.^3+(-3) ...
        .*ZT1.^2.*ZT12.^(1+N).*ZT3.^3+ZT1.^4.*ZT12.^(1+N).*ZT3.^3+(-2).* ...
        ZT1.^2.*ZT12.*ZT3.^4+N.*ZT1.^2.*ZT12.*ZT3.^4+ZT1.^3.*ZT12.*ZT3.^4+ ...
        (-1).*N.*ZT1.^3.*ZT12.*ZT3.^4+ZT1.^(1+N).*ZT12.*ZT3.^4+2.*ZT1.* ...
        ZT12.^2.*ZT3.^4+(-1).*N.*ZT1.*ZT12.^2.*ZT3.^4+N.*ZT1.^3.*ZT12.^2.* ...
        ZT3.^4+(-2).*ZT1.^(1+N).*ZT12.^2.*ZT3.^4+(-1).*ZT1.*ZT12.^3.* ...
        ZT3.^4+N.*ZT1.*ZT12.^3.*ZT3.^4+(-1).*N.*ZT1.^2.*ZT12.^3.*ZT3.^4+ ...
        ZT1.^(1+N).*ZT12.^3.*ZT3.^4+(-1).*ZT1.*ZT12.^(1+N).*ZT3.^4+2.* ...
        ZT1.^2.*ZT12.^(1+N).*ZT3.^4+(-1).*ZT1.^3.*ZT12.^(1+N).*ZT3.^4+(-1) ...
        .*ZT1.^2.*ZT12.*ZT3.^(1+N)+2.*ZT1.^3.*ZT12.*ZT3.^(1+N)+(-1).* ...
        ZT1.^4.*ZT12.*ZT3.^(1+N)+ZT1.*ZT12.^2.*ZT3.^(1+N)+(-3).*ZT1.^3.* ...
        ZT12.^2.*ZT3.^(1+N)+2.*ZT1.^4.*ZT12.^2.*ZT3.^(1+N)+(-2).*ZT1.* ...
        ZT12.^3.*ZT3.^(1+N)+3.*ZT1.^2.*ZT12.^3.*ZT3.^(1+N)+(-1).*ZT1.^4.* ...
        ZT12.^3.*ZT3.^(1+N)+ZT1.*ZT12.^4.*ZT3.^(1+N)+(-2).*ZT1.^2.* ...
        ZT12.^4.*ZT3.^(1+N)+ZT1.^3.*ZT12.^4.*ZT3.^(1+N));
        %}
    elseif ((1-c)*N<cut1) % 0.12*2^(log10(N)-2))
        % 1~a~b~c 
        out=-N*(N-1)*(N-2)*(N-3)*((N+1)*(3-a-b-c)-5)/120;
    elseif ((b-c)*N/abs(a)<cut) && ( (a-c)*N/abs(a)<cut )
        % 1 !~ a~b~c 
        % I have measured w.r.t. c as this gives best results
        M1=[...
            0   0   0   0;...
            -1  6   -11 6;...
            3   -12 3   18;...
            -3  6   9   0;...
            1   0   -1  0;...
            0   0   0   0;...
            0   0   0   0;...
            0   0   -6  -6;...
            0   0   6   -18];

        M2=[...
            0   3   -15 18;...
            0   -9  33  -18;...
            0   9   -21 0;...
            0   -3  3   0;...
            0   0   0   0;...
            0   0   -6  0;...
            0   0   12  -18;...
            0   0   -6  18;...
            0   0   0   0];

        vL=(c*ones(1,9)).^[N+4,N+3,N+2,N+1,N,5,4,3,2];
        vR=[N^3;N^2;N;1];

        out=vL*(M1*((b-a)+2*(c-b))+M2)*vR/(6*(c-1)^5);
        
        
    elseif ((1-b)*N < cut1)
        %  1~a~b !~ c
        delta_ab=0.139;
        delta_1a=0.149087;

        M1=...
        [1,-2,-1,2,0;...
         -4,12,4,-12,0;...
         6,-24,6,36,0;...
         -4,20,-20,-20,24;...
         1,-6,11,-6,0];

        M2=...
        [0,2,-6,4,0;...
         0,-8,30,-22,0;...
         0,12,-54,54,0;...
         0,-8,42,-58,12;...
         0,2,-12,22,-12];

        vL=[c^5,c^4,c^3,c^2,c];
        vR=[N^4;N^3;N^2;N;1];

        out=(vL*( (delta_ab+2*delta_1a)*M1-2*M2 )*vR...
            -(delta_ab+2*delta_1a)*24*c^(N+2)...ls
            /(24*(c-1)^5);
    elseif (1-a)*N<cut1 && (b-c)*N/abs(b)<cut
        % 1~a !~ b~c
        M1=[...
            0   0   -6  18;...
            0   0   6   6;...
            0   0   0   0;...
            0   0   0   0;...
            -1  0   1   0;...
            3   -6  -9  0;...
            -3  12  -3  -18;...
            1   -6  11  -6;...
            0   0   0   0];
        M2=[...
            0   0   0   0;...
            0   -3  15  -18;...
            0   6   -12 -18;...
            0   -3   -3 0;...
            0   0   0   0;...
            0   0   0   0;...
            0   3   3   0;...
            0   -6  12  18;...
            0   3   -15 18];
        M3=[...
            0   0   6   -18;...
            0   0   -12 18;...
            0   0   6   0;...
            0   0   0   0;...
            0   3   -3  0;...
            0   -9  21  0;...
            0   9   -33 18;...
            0   -3  15  -18;...
            0   0   0   0];
        vL=(c*ones(1,9)).^[N+3,N+2,N+1,N,5,4,3,2,1];
        vR=[N^3;N^2;N;1];

        out=vL*(M1*(1-a)+ M2*(c-b) + M3)*vR/(6*(c-1)^5);
    elseif 0 % (1-a)*N<cut1
        % 1~a !~ b !~ c
        % HooperHumperdink can always do this one
        M1=[...
            1   0   -1  -6;...
            -3  3   6   18;...
            3   -6  -3  -12;...
            -1  3   -2  6];
        M2=[...
            0   -3  3   6;...
            0   9   -15 -18;...
            0   -9  21  12;...
            0   3   -9  0];
        M3=[...
            -2  3   5   -6;...
            6   -15 -15 24;...
            -6  21  3   -36;...
            2   -9  7   6];
        M4=[...
            0   6   -12 0;...
            0   -18 48  -6;...
            0   18  -60 24;...
            0   -6  24  -18];
        M5=[...
            1   -3  2   0;...
            -3  12  -9  0;...
            3   -15 18  0;...
            -1  6   -11 6];
        M6=[...
            0   -3  9   -6;...
            0   9   -33 24;...
            0   -9  39  -36;...
            0   3   -15 18];
        M7=[...
            -18 18  -6;...
            18  -6  0;...
            -6  0   0];
        M8=[...
            12  -18 6;...
            -18 24  -6;...
            6   -6  0];
        alpha1=((c*ones(1,4)).^[5,4,3,2])*(M1*(1-a)*b^3+...
                                           M2*b^3+...
                                           M3*(1-a)*b^2+...
                                           M4*b^2+...
                                           M5*(1-a)*b+...
                                           M6*b)*((N*ones(4,1)).^[3;2;1;0]);
        alpha2=[b^3,b^2,b]*(M7*(1-a)+M8)*[c^(N+2);c^(N+1);c^N];

        alpha3=b*(b*(1-a)-b+1) * ((c^2-c^3)*b^N+(c^3-c^N)*b^2+(c^N-c^2)*b^3)/...
               ( c*(b-c)*(b-1)*(c-1) );
         out=-(b-1)^(-3)*((alpha1+alpha2)/(6*c*(c-1)^4) -alpha3);  
    elseif (a-b)*N/abs(b)<cut
        % 1 !~ a~b !~ c
         M1=[...
             0  0   N^2-5*N+6;...
             0  8*N-2*N^2-6   6*N-2*N^2;...
             N^2-3*N+2  4*N^2-8*N-8 N^2-N-2;...
             2*N-2*N^2+4    6-2*N^2 0;...
             N^2+N-2    0   0;...
             -2 -4  -4;...
             8  12  0;...
             -10    0   0];
         M2=[0  0   3   -6  3;...
             0  -2  3   0   -1;...
             0  0   0   0   0;...
             -1 0   0   0   1;...
             3  0   0   0   -3;...
             -3 0   -3  6   0;...
             1  2   -3  0   0];
         M3=[...
             0  0   -1  2   -1;...
             0  1   -1  -1  1;...
             0  -1  2   -1  0;...
             0  0   0   1   -1;...
             0  0   -2  1   1;...
             0  1   1   -2  0;...
             0  -1  1   0   0];

         T1=c*(b-1)^(-2)*((b*ones(1,8)).^[N+4,N+3,N+2,N+1,N,5,4,3])*M1*[c^2;c;1];

         T2=-2*b^2*(c^3-c^N)*(b-2*c+b*c)/(c-1);

         T3=-c^2*(1-c)*(b^4-b^(N+1))*(1-b)^(-1)...
            +b^2*(1-b)*(c^4-c^(N+1))*(1-c)^(-1)...
            +b^2*c^2*(b-c)*(N-3);
         T4=b*c*( (b-c)^2*(b-1)^3*(c-1)^2 )^(-1)*...
             ((b*ones(1,7)).^[N+2,N+1,N,4,3,2,1])*...
             (M2+M3*N)*...
             ((c*ones(5,1)).^[N;3;2;1;0]);

        out=(a-b)*( (T1-T2)/(2*(b-1)^2*(b-c)^3) + T3/(b*c*(b-c)*(b-1)^3*(c-1)))-T4;
        
    elseif (b-c)*N/abs(c)<cut
        % 1 !~ a !~ b~c
        %This is the same as above with a and c switched
        a=order(1);b=order(2);c=order(3);
         M1=[...
             0  0   N^2-5*N+6;...
             0  8*N-2*N^2-6   6*N-2*N^2;...
             N^2-3*N+2  4*N^2-8*N-8 N^2-N-2;...
             2*N-2*N^2+4    6-2*N^2 0;...
             N^2+N-2    0   0;...
             -2 -4  -4;...
             8  12  0;...
             -10    0   0];
         M2=[0  0   3   -6  3;...
             0  -2  3   0   -1;...
             0  0   0   0   0;...
             -1 0   0   0   1;...
             3  0   0   0   -3;...
             -3 0   -3  6   0;...
             1  2   -3  0   0];
         M3=[...
             0  0   -1  2   -1;...
             0  1   -1  -1  1;...
             0  -1  2   -1  0;...
             0  0   0   1   -1;...
             0  0   -2  1   1;...
             0  1   1   -2  0;...
             0  -1  1   0   0];

         T1=c*(b-1)^(-2)*((b*ones(1,8)).^[N+4,N+3,N+2,N+1,N,5,4,3])*M1*[c^2;c;1];

         T2=-2*b^2*(c^3-c^N)*(b-2*c+b*c)/(c-1);

         T3=-c^2*(1-c)*(b^4-b^(N+1))*(1-b)^(-1)...
            +b^2*(1-b)*(c^4-c^(N+1))*(1-c)^(-1)...
            +b^2*c^2*(b-c)*(N-3);
         T4=b*c*( (b-c)^2*(b-1)^3*(c-1)^2 )^(-1)*...
             ((b*ones(1,7)).^[N+2,N+1,N,4,3,2,1])*...
             (M2+M3*N)*...
             ((c*ones(5,1)).^[N;3;2;1;0]);

        out=(a-b)*( (T1-T2)/(2*(b-1)^2*(b-c)^3) + T3/(b*c*(b-c)*(b-1)^3*(c-1)))-T4;
        a=order(3);b=order(2);c=order(1); % put back in origional order
    else
       
        
        outs=[0;0;0;0];
        v1=[x1,x1,x3,x3,x1-x3,3*x2-N*x2];
        v2=[expl(2,x1),expl(2,x1),expl(2,x3),expl(2,x3),...
            expl(2,x1)-expl(2,x3),expl(2,3*x2)-expl(2,N*x2)];
        outs(1)= hooperHumperdink(v1,v2);

        v1=[x2,x2,x3,x3,x2-x3,3*x1-N*x1];
        v2=[expl(2,x2),expl(2,x2),expl(2,x3),expl(2,x3),...
            expl(2,x2)-expl(2,x3),expl(2,3*x1)-expl(2,N*x1)];
        outs(2)=(-1)*hooperHumperdink(v1,v2);

        v1=[x1,x1,x2,x2,x1-x2,3*x3-N*x3];
        v2=[expl(2,x1),expl(2,x1),expl(2,x2),expl(2,x2),...
            expl(2,x1)-expl(2,x2),expl(2,3*x3)-expl(2,N*x3)];
        outs(3)=(-1)*hooperHumperdink(v1,v2);

        v1=[x1,x2,x3,x1-x2,x1-x3,x2-x3];
        v2=[expl(2,x1),expl(2,x2),expl(2,x3),...
            expl(2,x1)-expl(2,x2),...
            expl(2,x1)-expl(2,x3),...
            expl(2,x2)-expl(2,x3)];
        outs(4)=hooperHumperdink(v1,v2)*(3-N);
        out=sum(outs);
        
        if 0 % abs(max(outs)/out)>1e6
            sprintf('a=%g, b=%g, c=%g',a,b,c)
            disp('outs')
            disp(outs)
            disp('out')
            disp(out)
            error('disaster')
        end
        out=out*a*b*c*( (a-1)^2*(b-1)^2*(c-1)^2*(a-b)*(a-c)*(b-c) )^(-1);
    end 
end

function xf=finite(x)
    MIN=-1e5;
    MAX=1e5;
    xf=x;
    xf(xf>MAX | xf<MIN)=0;
    xf(isnan(xf))=0;
end