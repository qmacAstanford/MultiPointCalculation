function S4=case7(N,NM,R1,R12,R3,Z1,Z1L,Z3,Z3L,F,order)
    if N<3
        S4=zeros(2,2,2,2);
        return
    end
    % Case 7: J1 <J2==J3 <J4
    E1=R1;
    E12=R12;
    E3=R3;            
    ZE1=[Z1,Z1L];
    ZE3=[Z3,Z3L];

    % on same monomer
    MIN=(10^-4)/NM;
    if max(abs([E1,E12,E3]))<MIN
        valeq=NM^4*(-NM*(E1-2*E12+E3)+6)/12;
    elseif max(abs([E1,E12]))<MIN
        valeq=NM*(2*(E1+E12+E3)*(expl(1,NM*E3)+expl(1,-NM*E3))...
                +NM*E3*(2*E3+NM*E3*E12+2*E12+E1*(exp(NM*E3)+1))*expl(1,-NM*E3))...
                /(2*E3^4);
    elseif max(abs([E12,E3]))<MIN
        valeq=NM*(2*(E1+E12+E3)*(expl(1,NM*E1)+expl(1,-NM*E1))...
                +NM*E1*(2*E1+NM*E1*E12+2*E12+E3*(exp(NM*E1)+1))*expl(1,-NM*E1))...
                /(2*E1^4);
    elseif max(abs([E1,E3]))<MIN
        valeq=NM^2*(2*(E1+E12+E3)*expl(2,NM*E12)-NM*(E1+E3)*E12*expl(1,NM*E12))/(2*E12^3);
    elseif (abs(E1-E12)<MIN && abs(E12-E3)<MIN)
       valeq=(1/2).*(exp(1).^E1).^((-1).*NM).*((-1)+(exp(1).^E1).^NM).^2.* ...
       NM.^2.*log(exp(1).^E1).^(-2);
    elseif abs(E1-E12)<MIN
       valeq=(exp(1).^E1).^((-1).*NM).*((-1)+(exp(1).^E1).^NM).*(1+(-1).*(exp( ...
       1).^E3).^((-1).*NM)).*log(exp(1).^E1).^(-1).*(log(exp(1).^E1)+(-1) ...
       .*log(exp(1).^E3)).^(-2).*log(exp(1).^E3).^(-1).*((exp(1).^E3) ...
       .^NM+(exp(1).^E1).^NM.*((-1)+NM.*log(exp(1).^E1)+(-1).*NM.*log( ...
       exp(1).^E3)));
    elseif abs(E1-E3)<MIN
       valeq=(exp(1).^E1).^((-2).*NM).*((-1)+(exp(1).^E1).^NM).^2.*log(exp(1) ...
       .^E1).^(-2).*(log(exp(1).^E1)+(-1).*log(exp(1).^E12)).^(-2).*(( ...
       exp(1).^E12).^NM+(exp(1).^E1).^NM.*((-1)+NM.*log(exp(1).^E1)+(-1) ...
       .*NM.*log(exp(1).^E12)));
    elseif abs(E12-E3)<MIN
       valeq=(exp(1).^E1).^((-1).*NM).*((-1)+(exp(1).^E1).^NM).*(1+(-1).*(exp( ...
       1).^E12).^((-1).*NM)).*log(exp(1).^E1).^(-1).*(log(exp(1).^E1)+( ...
       -1).*log(exp(1).^E12)).^(-2).*log(exp(1).^E12).^(-1).*((exp(1) ...
       .^E1).^NM+(-1).*(exp(1).^E12).^NM+(-1).*(exp(1).^E12).^NM.*NM.* ...
       log(exp(1).^E1)+(exp(1).^E12).^NM.*NM.*log(exp(1).^E12));
    else
       valeq=(exp(1).^E1).^((-1).*NM).*((-1)+(exp(1).^E1).^NM).*(1+(-1).*(exp( ...
       1).^E3).^((-1).*NM)).*log(exp(1).^E1).^(-1).*(log(exp(1).^E1)+(-1) ...
       .*log(exp(1).^E12)).^(-1).*(log(exp(1).^E1)+(-1).*log(exp(1).^E3)) ...
       .^(-1).*log(exp(1).^E3).^(-1).*((-1).*log(exp(1).^E12)+log(exp(1) ...
       .^E3)).^(-1).*(((exp(1).^E12).^NM+(-1).*(exp(1).^E3).^NM).*log( ...
       exp(1).^E1)+((-1).*(exp(1).^E1).^NM+(exp(1).^E3).^NM).*log(exp(1) ...
       .^E12)+((exp(1).^E1).^NM+(-1).*(exp(1).^E12).^NM).*log(exp(1).^E3) ...
       );
    end

%     valeq=expl(1,-NM*E1)*expl(1,-NM*E3)*(...
%           (expl(2,NM*E3)-expl(2,NM*E12))*(E1-E3)+...
%           (expl(2,NM*E1)-expl(2,NM*E3))*(E12-E3))/...
%           ( E1*E3*(E12-E3)*(E1-E3)*(E1-E12) );
    
    % on different monomers
    
    if isnan(valeq)
        sprintf('E1=%g+%gi,E12=%g+%gi,E3=%g+%gi',real(E1),imag(E1),real(E12),imag(E12),real(E3),imag(E3))
        error('NaN encountered')
    end
    valne=zeros(2,2,2);
    for I1=1:2
        for I3=1:2
            ZT1=ZE1(I1);
            ZT3=ZE3(I3);
            valne(I1,1,I3)=tripleSum(ZT1,ZT3,N);
            valne(I1,2,I3)=valne(I1,1,I3);
        end
    end

    S4=BinomialSum(valeq,valne,order,F);

end